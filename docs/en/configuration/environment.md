# Environment Configuration

This guide covers the configuration of environment variables and basic settings for the Family VPN Server.

## Overview

Environment configuration controls the basic operation of the VPN server, including network settings, paths, and runtime behavior. Proper environment configuration is essential for secure and reliable operation.

## Configuration Files

### Primary Configuration File (`.env`)

The `.env` file contains all environment variables and is the primary configuration file:

```env
# Server Configuration
NODE_ENV=production
VPN_HOST=your-server-ip-address
VPN_PORT=1194
API_PORT=3000

# Network Configuration
VPN_SUBNET=10.8.0.0
VPN_NETMASK=255.255.255.0

# Path Configuration
VPN_CONFIG_DIR=/etc/openvpn
VPN_CERT_DIR=/etc/openvpn/certificates
LOG_DIR=./logs

# Authentication Configuration
VPN_USERNAME=admin
VPN_PASSWORD_HASH=generated_bcrypt_hash
JWT_SECRET=generated_jwt_secret
JWT_REFRESH_SECRET=generated_refresh_secret
SESSION_SECRET=generated_session_secret

# Security Configuration
JWT_EXPIRY=15m
JWT_REFRESH_EXPIRY=7d
MAX_FAILED_ATTEMPTS=5
LOCKOUT_DURATION=900000
ENFORCE_IP_VALIDATION=false

# Certificate Configuration
CERT_KEY_SIZE=2048
CERT_VALIDITY_DAYS=365

# Logging Configuration
LOG_LEVEL=info
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100

# Docker Configuration (if using Docker)
DOCKER_ENV=true
```

### Environment File Templates

#### Development Environment (`.env.development`)
```env
NODE_ENV=development
VPN_HOST=127.0.0.1
API_PORT=3000
LOG_LEVEL=debug
ENFORCE_IP_VALIDATION=false
```

#### Production Environment (`.env.production`)
```env
NODE_ENV=production
VPN_HOST=your-production-ip
API_PORT=3000
LOG_LEVEL=info
ENFORCE_IP_VALIDATION=true
RATE_LIMIT_MAX=50
```

## Configuration Categories

### Server Configuration

#### Basic Server Settings
```env
# Environment mode (development, production, test)
NODE_ENV=production

# Server IP address (public IP for cloud, local IP for home)
VPN_HOST=192.168.1.100

# OpenVPN port (default 1194, must be UDP)
VPN_PORT=1194

# Web management interface port
API_PORT=3000
```

#### Server IP Configuration

**For Local/Home Network:**
```env
# Use your computer's local IP
VPN_HOST=192.168.1.100

# Or use your router's external IP for remote access
VPN_HOST=203.0.113.1
```

**For Cloud Servers:**
```env
# Use the server's public IP
VPN_HOST=203.0.113.50

# Or use a domain name
VPN_HOST=vpn.yourdomain.com
```

**Finding Your IP Address:**
```bash
# Local IP (Linux/macOS)
hostname -I | awk '{print $1}'

# Local IP (Windows)
ipconfig | findstr "IPv4"

# Public IP
curl ifconfig.me
```

### Network Configuration

#### VPN Network Settings
```env
# VPN subnet (private network for VPN clients)
VPN_SUBNET=10.8.0.0

# VPN netmask (defines network size)
VPN_NETMASK=255.255.255.0

# Alternative subnets (avoid conflicts with local networks)
# VPN_SUBNET=10.9.0.0    # If 10.8.x.x conflicts
# VPN_SUBNET=172.16.0.0  # Alternative private range
# VPN_SUBNET=192.168.100.0  # Another alternative
```

#### Network Conflict Resolution
If your local network uses the same subnet as the VPN:

```env
# Check your local network
# ip route show | grep default

# If local network is 10.8.x.x, use different VPN subnet
VPN_SUBNET=10.9.0.0
VPN_NETMASK=255.255.255.0

# If local network is 192.168.1.x, VPN can use 10.8.x.x
VPN_SUBNET=10.8.0.0
VPN_NETMASK=255.255.255.0
```

### Path Configuration

#### System-wide Installation Paths
```env
# Standard system paths (requires root/admin privileges)
VPN_CONFIG_DIR=/etc/openvpn
VPN_CERT_DIR=/etc/openvpn/certificates
LOG_DIR=/var/log/openvpn

# Windows system paths
# VPN_CONFIG_DIR=C:\ProgramData\OpenVPN\config
# VPN_CERT_DIR=C:\ProgramData\OpenVPN\certificates
```

#### User-local Installation Paths
```env
# User directory paths (no admin privileges required)
VPN_CONFIG_DIR=/home/username/.privatevpn/config
VPN_CERT_DIR=/home/username/.privatevpn/certificates
LOG_DIR=/home/username/.privatevpn/logs

# macOS user paths
# VPN_CONFIG_DIR=/Users/username/.privatevpn/config
# VPN_CERT_DIR=/Users/username/.privatevpn/certificates

# Windows user paths
# VPN_CONFIG_DIR=C:\Users\username\.privatevpn\config
# VPN_CERT_DIR=C:\Users\username\.privatevpn\certificates
```

#### Docker Paths
```env
# Docker container paths (managed by Docker)
VPN_CONFIG_DIR=/app/config
VPN_CERT_DIR=/app/certificates
LOG_DIR=/app/logs
DOCKER_ENV=true
```

### Authentication Configuration

#### Admin Credentials
```env
# Admin username for web interface
VPN_USERNAME=admin

# Bcrypt hash of admin password (generated by setup-auth script)
VPN_PASSWORD_HASH=$2b$12$example.hash.here

# Generate hash manually:
# node -e "console.log(require('bcrypt').hashSync('your-password', 12))"
```

#### JWT Configuration
```env
# JWT secret for token signing (generate with crypto.randomBytes(32).toString('hex'))
JWT_SECRET=64-character-hex-string

# JWT refresh token secret
JWT_REFRESH_SECRET=64-character-hex-string

# Session secret for web interface
SESSION_SECRET=64-character-hex-string

# Token expiration times
JWT_EXPIRY=15m          # Access token (15 minutes)
JWT_REFRESH_EXPIRY=7d   # Refresh token (7 days)
```

#### Generate Secure Secrets
```bash
# Generate secrets automatically
npm run setup-auth

# Or generate manually
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### Security Configuration

#### Authentication Security
```env
# Maximum failed login attempts before lockout
MAX_FAILED_ATTEMPTS=5

# Lockout duration in milliseconds (15 minutes = 900000)
LOCKOUT_DURATION=900000

# Enforce IP validation for JWT tokens
ENFORCE_IP_VALIDATION=false  # Set to true for production

# Session timeout (30 minutes = 1800000)
SESSION_TIMEOUT=1800000
```

#### Rate Limiting
```env
# Rate limiting window in minutes
RATE_LIMIT_WINDOW=15

# Maximum requests per window
RATE_LIMIT_MAX=100

# Slow down threshold (requests before slowing down)
SLOW_DOWN_THRESHOLD=50

# Slow down delay increment (milliseconds)
SLOW_DOWN_DELAY=500
```

### Certificate Configuration

#### Certificate Parameters
```env
# RSA key size for certificates (2048 minimum, 4096 for high security)
CERT_KEY_SIZE=2048

# Certificate validity in days (365 = 1 year)
CERT_VALIDITY_DAYS=365

# Certificate organization details
CERT_COUNTRY=US
CERT_STATE=State
CERT_CITY=City
CERT_ORG=Family VPN
CERT_EMAIL=admin@example.com
```

#### Certificate Paths
```env
# Certificate file names (relative to VPN_CERT_DIR)
CA_CERT=ca.crt
CA_KEY=ca.key
SERVER_CERT=server.crt
SERVER_KEY=server.key
DH_PARAMS=dh.pem
TLS_AUTH_KEY=ta.key
```

### Logging Configuration

#### Log Levels and Output
```env
# Log level (error, warn, info, debug)
LOG_LEVEL=info

# Enable/disable specific log types
ENABLE_ACCESS_LOG=true
ENABLE_ERROR_LOG=true
ENABLE_SECURITY_LOG=true

# Log file rotation
LOG_MAX_SIZE=10m        # Maximum log file size
LOG_MAX_FILES=5         # Number of rotated files to keep
LOG_DATE_PATTERN=YYYY-MM-DD  # Date pattern for rotation
```

#### Development Logging
```env
# Development-specific logging
NODE_ENV=development
LOG_LEVEL=debug
DEBUG=*                 # Enable all debug output
LOGGER=1               # Enable console logging
```

### Performance Configuration

#### Server Performance
```env
# Node.js performance settings
NODE_OPTIONS=--max-old-space-size=1024

# OpenVPN performance settings
OPENVPN_VERB=3         # Verbosity level (0-11)
OPENVPN_MUTE=20        # Mute repeated messages

# Connection limits
MAX_CLIENTS=50         # Maximum concurrent VPN clients
```

#### Resource Limits
```env
# Memory limits (for Docker)
MEMORY_LIMIT=1g

# CPU limits
CPU_LIMIT=1.0

# File descriptor limits
ULIMIT_NOFILE=65536
```

## Initial Setup

### 1. Create Environment File
```bash
# Copy example configuration
cp .env.example .env

# Edit configuration
nano .env
```

### 2. Set Required Variables
Minimum required configuration:
```env
VPN_HOST=YOUR_SERVER_IP_HERE
NODE_ENV=production
```

### 3. Run Setup Scripts
```bash
# Generate authentication secrets
npm run setup-auth

# Initialize PKI
npm run init-pki

# Apply security hardening
npm run harden-config
```

### 4. Validate Configuration
```bash
# Test configuration loading
node -e "require('dotenv').config(); console.log('VPN_HOST:', process.env.VPN_HOST)"

# Validate all settings
npm run config:validate
```

## Environment-Specific Configuration

### Development Environment
```env
NODE_ENV=development
VPN_HOST=127.0.0.1
LOG_LEVEL=debug
ENFORCE_IP_VALIDATION=false
RATE_LIMIT_MAX=1000
```

### Production Environment
```env
NODE_ENV=production
VPN_HOST=your-production-ip
LOG_LEVEL=info
ENFORCE_IP_VALIDATION=true
RATE_LIMIT_MAX=50
MAX_FAILED_ATTEMPTS=3
```

### Docker Environment
```env
DOCKER_ENV=true
VPN_CONFIG_DIR=/app/config
VPN_CERT_DIR=/app/certificates
LOG_DIR=/app/logs
```

## Configuration Validation

### Validation Script
Create a validation script to check configuration:

```javascript
// scripts/validate-config.js
const fs = require('fs');
require('dotenv').config();

const requiredVars = [
  'VPN_HOST',
  'VPN_SUBNET',
  'VPN_NETMASK',
  'JWT_SECRET',
  'SESSION_SECRET'
];

console.log('Validating configuration...');

for (const varName of requiredVars) {
  if (!process.env[varName]) {
    console.error(`❌ Missing required variable: ${varName}`);
    process.exit(1);
  }
  console.log(`✅ ${varName}: ${process.env[varName]}`);
}

console.log('✅ Configuration validation passed!');
```

### Run Validation
```bash
# Add to package.json scripts
"config:validate": "node scripts/validate-config.js"

# Run validation
npm run config:validate
```

## Troubleshooting

### Common Issues

#### Environment Variables Not Loading
```bash
# Check .env file exists
ls -la .env

# Check file permissions
chmod 600 .env

# Test loading
node -e "require('dotenv').config(); console.log(process.env.VPN_HOST)"
```

#### Invalid IP Address
```bash
# Verify IP address format
ping -c 1 $VPN_HOST

# Check if IP is reachable
curl -m 5 http://$VPN_HOST:$API_PORT/health
```

#### Path Issues
```bash
# Check directory permissions
ls -la $VPN_CONFIG_DIR
ls -la $VPN_CERT_DIR

# Create directories if missing
mkdir -p $VPN_CONFIG_DIR $VPN_CERT_DIR
```

#### Port Conflicts
```bash
# Check if ports are available
netstat -tulnp | grep -E "(1194|3000)"

# Change ports if needed
VPN_PORT=1195
API_PORT=3001
```

### Debug Configuration
```bash
# Run with debug output
DEBUG=config:* npm start

# Check environment loading
LOG_LEVEL=debug npm start

# Validate specific settings
node -e "
require('dotenv').config();
console.log('Environment:', process.env.NODE_ENV);
console.log('VPN Host:', process.env.VPN_HOST);
console.log('VPN Subnet:', process.env.VPN_SUBNET);
console.log('Config Dir:', process.env.VPN_CONFIG_DIR);
console.log('Cert Dir:', process.env.VPN_CERT_DIR);
"
```

## Security Best Practices

### Protect Configuration Files
```bash
# Secure .env file permissions
chmod 600 .env
chown $USER:$USER .env

# Never commit .env to version control
echo ".env" >> .gitignore
```

### Use Strong Secrets
```bash
# Generate cryptographically secure secrets
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Use different secrets for different purposes
JWT_SECRET=secret1
JWT_REFRESH_SECRET=secret2
SESSION_SECRET=secret3
```

### Regular Updates
```bash
# Regularly rotate secrets (monthly/quarterly)
npm run setup-auth

# Update configuration for security patches
# Review and update .env file regularly
```

## Maintenance Configuration

### Backup Configuration
```bash
# Backup configuration files
cp .env .env.backup.$(date +%Y%m%d)

# Backup entire configuration
tar -czf config-backup-$(date +%Y%m%d).tar.gz .env src/config.js certificates/
```

### Configuration Monitoring
```bash
# Monitor configuration changes
# Add to crontab for regular checks
0 0 * * * /path/to/family-vpn-server/scripts/config-check.sh
```

### Update Procedures
```bash
# Before updating
cp .env .env.backup

# After updating
npm run config:validate
npm test
```

## Next Steps

After configuring environment settings:

1. **[Security Configuration](security.md)** - Set up authentication and encryption
2. **[Network Configuration](networking.md)** - Configure networking and firewall
3. **[Certificate Configuration](certificates.md)** - Set up PKI and certificates