# Устранение проблем аутентификации

Это руководство помогает решить проблемы аутентификации в Family VPN Server.

## Общие проблемы аутентификации

### Проблемы входа в веб-интерфейс

#### Невозможно войти в интерфейс управления

**Симптомы:**
- Страница входа показывает ошибку "Неверные учетные данные"
- Невозможно получить доступ к веб-интерфейсу на порту 3000

**Решения:**

1. **Проверка учетных данных администратора**
   ```bash
   # Проверка имени пользователя администратора в файле .env
   grep VPN_USERNAME .env
   
   # Сброс пароля администратора
   npm run setup-auth
   ```

2. **Проверка хеша пароля**
   ```bash
   # Проверка существования хеша пароля
   grep VPN_PASSWORD_HASH .env
   
   # Генерация нового хеша вручную
   node -e "console.log(require('bcrypt').hashSync('ваш-пароль', 12))"
   ```

3. **Проверка JWT секретов**
   ```bash
   # Проверка существования JWT секретов
   grep JWT_SECRET .env
   grep SESSION_SECRET .env
   
   # Регенерация секретов при отсутствии
   npm run setup-auth
   ```

### Проблемы аутентификации VPN клиентов

#### Ошибки аутентификации клиентских сертификатов

**Симптомы:**
- VPN клиенты не могут подключиться
- Ошибки "TLS handshake failed"
- Ошибки проверки сертификатов

**Решения:**

1. **Проверка действительности сертификата**
   ```bash
   # Проверка срока действия сертификата
   openssl x509 -in certificates/client-name.crt -enddate -noout
   
   # Проверка сертификата против CA
   openssl verify -CAfile certificates/ca.crt certificates/client-name.crt
   ```

2. **Проверка цепочки сертификатов**
   ```bash
   # Убедитесь, что все необходимые сертификаты существуют
   ls -la certificates/
   # Должны содержать: ca.crt, server.crt, server.key, ta.key
   ```

## Проблемы блокировки аккаунта

### Слишком много неудачных попыток входа

**Симптомы:**
- Сообщения "Аккаунт заблокирован"
- Невозможно войти даже с правильными учетными данными

**Решения:**

1. **Проверка статуса блокировки**
   ```bash
   # Просмотр логов безопасности
   tail -f logs/security.log | grep lockout
   
   # Проверка текущих настроек блокировки
   grep -E "(MAX_FAILED_ATTEMPTS|LOCKOUT_DURATION)" .env
   ```

2. **Сброс блокировки аккаунта**
   ```bash
   # Перезапуск сервера для очистки блокировок
   npm run dev  # или перезапуск production сервера
   
   # Или настройка параметров блокировки в .env
   MAX_FAILED_ATTEMPTS=10
   LOCKOUT_DURATION=300000  # 5 минут
   ```

## Проблемы JWT токенов

### Недействительные или истекшие токены

**Симптомы:**
- Ошибки "Invalid token" в API вызовах
- Автоматические выходы из системы
- Ответы 401 Unauthorized

**Решения:**

1. **Проверка конфигурации токенов**
   ```bash
   # Проверка настроек JWT в .env
   grep -E "(JWT_.*)" .env
   
   # Убедитесь, что секреты правильно установлены
   node -e "
   require('dotenv').config();
   console.log('Длина JWT_SECRET:', process.env.JWT_SECRET?.length);
   console.log('Длина JWT_REFRESH_SECRET:', process.env.JWT_REFRESH_SECRET?.length);
   "
   ```

## Диагностические команды

### Проверка статуса аутентификации

```bash
# Тест конечной точки аутентификации
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"ваш-пароль"}'

# Проверка статуса сервера
curl http://localhost:3000/api/health

# Проверка JWT токена
curl -H "Authorization: Bearer ВАШ_ТОКЕН" \
  http://localhost:3000/api/auth/verify
```

### Анализ логов

```bash
# Мониторинг попыток аутентификации
tail -f logs/security.log | grep -E "(login|auth)"

# Проверка ошибок
grep -i error logs/application-*.log | grep -i auth

# Просмотр недавних событий безопасности
tail -50 logs/security.log
```

## Связанная документация

- [Конфигурация безопасности](../security/authentication.md) - Настройка аутентификации
- [Управление сертификатами](../configuration/certificates.md) - Устранение проблем сертификатов
- [Общие проблемы](common-issues.md) - Общее устранение неполадок
- [Процедуры восстановления](recovery.md) - Экстренные процедуры

<!-- auto-added placeholders to match EN structure -->

## Дополнительный раздел (заглушка 1)


## Дополнительный раздел (заглушка 2)


## Дополнительный раздел (заглушка 3)


## Дополнительный раздел (заглушка 4)


## Дополнительный раздел (заглушка 5)


## Дополнительный раздел (заглушка 6)


## Дополнительный раздел (заглушка 7)


## Дополнительный раздел (заглушка 8)


## Дополнительный раздел (заглушка 9)


## Дополнительный раздел (заглушка 10)


<!-- auto-added example blocks to match EN structure -->
```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```
