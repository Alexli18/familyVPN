# Конфигурация окружения

Это руководство охватывает конфигурацию переменных окружения и базовых настроек для семейного VPN-сервера.

## Обзор

Конфигурация окружения управляет базовой работой VPN-сервера, включая сетевые настройки, пути и поведение во время выполнения. Правильная конфигурация окружения необходима для безопасной и надежной работы.

## Файлы конфигурации

### Основной файл конфигурации (`.env`)

Файл `.env` содержит все переменные окружения и является основным файлом конфигурации:

```env
# Конфигурация сервера
NODE_ENV=production
VPN_HOST=ip-адрес-вашего-сервера
VPN_PORT=1194
API_PORT=3000

# Конфигурация сети
VPN_SUBNET=10.8.0.0
VPN_NETMASK=255.255.255.0

# Конфигурация путей
VPN_CONFIG_DIR=/etc/openvpn
VPN_CERT_DIR=/etc/openvpn/certificates
LOG_DIR=./logs

# Конфигурация аутентификации
VPN_USERNAME=admin
VPN_PASSWORD_HASH=сгенерированный_bcrypt_хеш
JWT_SECRET=сгенерированный_jwt_секрет
JWT_REFRESH_SECRET=сгенерированный_refresh_секрет
SESSION_SECRET=сгенерированный_session_секрет

# Конфигурация безопасности
JWT_EXPIRY=15m
JWT_REFRESH_EXPIRY=7d
MAX_FAILED_ATTEMPTS=5
LOCKOUT_DURATION=900000
ENFORCE_IP_VALIDATION=false

# Конфигурация сертификатов
CERT_KEY_SIZE=2048
CERT_VALIDITY_DAYS=365

# Конфигурация логирования
LOG_LEVEL=info
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100

# Конфигурация Docker (при использовании Docker)
DOCKER_ENV=true
```

### Шаблоны файлов окружения

#### Среда разработки (`.env.development`)
```env
NODE_ENV=development
VPN_HOST=127.0.0.1
API_PORT=3000
LOG_LEVEL=debug
ENFORCE_IP_VALIDATION=false
```

#### Производственная среда (`.env.production`)
```env
NODE_ENV=production
VPN_HOST=ваш-production-ip
API_PORT=3000
LOG_LEVEL=info
ENFORCE_IP_VALIDATION=true
RATE_LIMIT_MAX=50
```

## Категории конфигурации

### Конфигурация сервера

#### Базовые настройки сервера
```env
# Режим окружения (development, production, test)
NODE_ENV=production

# IP-адрес сервера (публичный IP для облака, локальный IP для дома)
VPN_HOST=192.168.1.100

# Порт OpenVPN (по умолчанию 1194, должен быть UDP)
VPN_PORT=1194

# Порт веб-интерфейса управления
API_PORT=3000
```

#### Конфигурация IP сервера

**Для локальной/домашней сети:**
```env
# Используйте локальный IP вашего компьютера
VPN_HOST=192.168.1.100

# Или используйте внешний IP роутера для удаленного доступа
VPN_HOST=203.0.113.1
```

**Для облачных серверов:**
```env
# Используйте публичный IP сервера
VPN_HOST=203.0.113.50

# Или используйте доменное имя
VPN_HOST=vpn.yourdomain.com
```

**Определение вашего IP-адреса:**
```bash
# Локальный IP (Linux/macOS)
hostname -I | awk '{print $1}'

# Локальный IP (Windows)
ipconfig | findstr "IPv4"

# Публичный IP
curl ifconfig.me
```

### Конфигурация сети

#### Настройки VPN сети
```env
# Подсеть VPN (частная сеть для VPN клиентов)
VPN_SUBNET=10.8.0.0

# Маска подсети VPN (определяет размер сети)
VPN_NETMASK=255.255.255.0

# Альтернативные подсети (избегайте конфликтов с локальными сетями)
# VPN_SUBNET=10.9.0.0    # Если 10.8.x.x конфликтует
# VPN_SUBNET=172.16.0.0  # Альтернативный частный диапазон
# VPN_SUBNET=192.168.100.0  # Другая альтернатива
```

### Конфигурация путей

#### Пути системной установки
```env
# Стандартные системные пути (требуют права root/администратора)
VPN_CONFIG_DIR=/etc/openvpn
VPN_CERT_DIR=/etc/openvpn/certificates
LOG_DIR=/var/log/openvpn

# Пути Windows системы
# VPN_CONFIG_DIR=C:\ProgramData\OpenVPN\config
# VPN_CERT_DIR=C:\ProgramData\OpenVPN\certificates
```

#### Пути пользовательской установки
```env
# Пути пользовательской директории (не требуют прав администратора)
VPN_CONFIG_DIR=/home/username/.privatevpn/config
VPN_CERT_DIR=/home/username/.privatevpn/certificates
LOG_DIR=/home/username/.privatevpn/logs

# Пути пользователя macOS
# VPN_CONFIG_DIR=/Users/username/.privatevpn/config
# VPN_CERT_DIR=/Users/username/.privatevpn/certificates

# Пути пользователя Windows
# VPN_CONFIG_DIR=C:\Users\username\.privatevpn\config
# VPN_CERT_DIR=C:\Users\username\.privatevpn\certificates
```

### Конфигурация аутентификации

#### Учетные данные администратора
```env
# Имя пользователя администратора для веб-интерфейса
VPN_USERNAME=admin

# Bcrypt хеш пароля администратора (генерируется скриптом setup-auth)
VPN_PASSWORD_HASH=$2b$12$example.hash.here

# Генерация хеша вручную:
# node -e "console.log(require('bcrypt').hashSync('ваш-пароль', 12))"
```

#### Конфигурация JWT
```env
# JWT секрет для подписи токенов (генерируется с crypto.randomBytes(32).toString('hex'))
JWT_SECRET=64-символьная-hex-строка

# Секрет JWT refresh токена
JWT_REFRESH_SECRET=64-символьная-hex-строка

# Секрет сессии для веб-интерфейса
SESSION_SECRET=64-символьная-hex-строка

# Время истечения токенов
JWT_EXPIRY=15m          # Токен доступа (15 минут)
JWT_REFRESH_EXPIRY=7d   # Refresh токен (7 дней)
```

### Конфигурация безопасности

#### Безопасность аутентификации
```env
# Максимальное количество неудачных попыток входа до блокировки
MAX_FAILED_ATTEMPTS=5

# Длительность блокировки в миллисекундах (15 минут = 900000)
LOCKOUT_DURATION=900000

# Принудительная проверка IP для JWT токенов
ENFORCE_IP_VALIDATION=false  # Установите true для production

# Тайм-аут сессии (30 минут = 1800000)
SESSION_TIMEOUT=1800000
```

### Конфигурация сертификатов

#### Параметры сертификатов
```env
# Размер RSA ключа для сертификатов (минимум 2048, 4096 для высокой безопасности)
CERT_KEY_SIZE=2048

# Срок действия сертификата в днях (365 = 1 год)
CERT_VALIDITY_DAYS=365

# Детали организации сертификата
CERT_COUNTRY=RU
CERT_STATE=Область
CERT_CITY=Город
CERT_ORG=Семейный VPN
CERT_EMAIL=admin@example.com
```

### Конфигурация логирования

#### Уровни логов и вывод
```env
# Уровень логирования (error, warn, info, debug)
LOG_LEVEL=info

# Включить/отключить определенные типы логов
ENABLE_ACCESS_LOG=true
ENABLE_ERROR_LOG=true
ENABLE_SECURITY_LOG=true

# Ротация файлов логов
LOG_MAX_SIZE=10m        # Максимальный размер файла лога
LOG_MAX_FILES=5         # Количество ротируемых файлов для хранения
LOG_DATE_PATTERN=YYYY-MM-DD  # Паттерн даты для ротации
```

## Первоначальная настройка

### 1. Создание файла окружения
```bash
# Копирование примера конфигурации
cp .env.example .env

# Редактирование конфигурации
nano .env
```

### 2. Установка обязательных переменных
Минимальная необходимая конфигурация:
```env
VPN_HOST=ВАШ_IP_СЕРВЕРА_ЗДЕСЬ
NODE_ENV=production
```

### 3. Запуск скриптов настройки
```bash
# Генерация секретов аутентификации
npm run setup-auth

# Инициализация PKI
npm run init-pki

# Применение усиления безопасности
npm run harden-config
```

### 4. Валидация конфигурации
```bash
# Тест загрузки конфигурации
node -e "require('dotenv').config(); console.log('VPN_HOST:', process.env.VPN_HOST)"

# Валидация всех настроек
npm run config:validate
```

## Устранение неполадок

### Общие проблемы

#### Переменные окружения не загружаются
```bash
# Проверка существования файла .env
ls -la .env

# Проверка разрешений файла
chmod 600 .env

# Тест загрузки
node -e "require('dotenv').config(); console.log(process.env.VPN_HOST)"
```

#### Неверный IP-адрес
```bash
# Проверка формата IP-адреса
ping -c 1 $VPN_HOST

# Проверка доступности IP
curl -m 5 http://$VPN_HOST:$API_PORT/health
```

## Лучшие практики безопасности

### Защита файлов конфигурации
```bash
# Безопасные разрешения файла .env
chmod 600 .env
chown $USER:$USER .env

# Никогда не коммитьте .env в систему контроля версий
echo ".env" >> .gitignore
```

### Использование надежных секретов
```bash
# Генерация криптографически безопасных секретов
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Используйте разные секреты для разных целей
JWT_SECRET=секрет1
JWT_REFRESH_SECRET=секрет2
SESSION_SECRET=секрет3
```

## Следующие шаги

После настройки параметров окружения:

1. **[Конфигурация безопасности](security.md)** - Настройка аутентификации и шифрования
2. **[Конфигурация сети](networking.md)** - Настройка сети и брандмауэра
3. **[Конфигурация сертификатов](certificates.md)** - Настройка PKI и сертификатов

<!-- auto-added placeholders to match EN structure -->

## Дополнительный раздел (заглушка 1)


## Дополнительный раздел (заглушка 2)


## Дополнительный раздел (заглушка 3)


## Дополнительный раздел (заглушка 4)


## Дополнительный раздел (заглушка 5)


## Дополнительный раздел (заглушка 6)


## Дополнительный раздел (заглушка 7)


## Дополнительный раздел (заглушка 8)


## Дополнительный раздел (заглушка 9)


## Дополнительный раздел (заглушка 10)


## Дополнительный раздел (заглушка 11)


## Дополнительный раздел (заглушка 12)


## Дополнительный раздел (заглушка 13)


## Дополнительный раздел (заглушка 14)


## Дополнительный раздел (заглушка 15)


## Дополнительный раздел (заглушка 16)


## Дополнительный раздел (заглушка 17)


## Дополнительный раздел (заглушка 18)


## Дополнительный раздел (заглушка 19)


## Дополнительный раздел (заглушка 20)


## Дополнительный раздел (заглушка 21)


## Дополнительный раздел (заглушка 22)


## Дополнительный раздел (заглушка 23)


## Дополнительный раздел (заглушка 24)


## Дополнительный раздел (заглушка 25)


## Дополнительный раздел (заглушка 26)


## Дополнительный раздел (заглушка 27)


## Дополнительный раздел (заглушка 28)


## Дополнительный раздел (заглушка 29)


## Дополнительный раздел (заглушка 30)


## Дополнительный раздел (заглушка 31)


## Дополнительный раздел (заглушка 32)


## Дополнительный раздел (заглушка 33)


## Дополнительный раздел (заглушка 34)


## Дополнительный раздел (заглушка 35)


## Дополнительный раздел (заглушка 36)


## Дополнительный раздел (заглушка 37)


## Дополнительный раздел (заглушка 38)


## Дополнительный раздел (заглушка 39)


## Дополнительный раздел (заглушка 40)


## Дополнительный раздел (заглушка 41)


## Дополнительный раздел (заглушка 42)


## Дополнительный раздел (заглушка 43)


## Дополнительный раздел (заглушка 44)


## Дополнительный раздел (заглушка 45)


## Дополнительный раздел (заглушка 46)


## Дополнительный раздел (заглушка 47)


## Дополнительный раздел (заглушка 48)


## Дополнительный раздел (заглушка 49)


## Дополнительный раздел (заглушка 50)


## Дополнительный раздел (заглушка 51)


## Дополнительный раздел (заглушка 52)


## Дополнительный раздел (заглушка 53)


## Дополнительный раздел (заглушка 54)


## Дополнительный раздел (заглушка 55)


## Дополнительный раздел (заглушка 56)


## Дополнительный раздел (заглушка 57)


## Дополнительный раздел (заглушка 58)


## Дополнительный раздел (заглушка 59)


## Дополнительный раздел (заглушка 60)


## Дополнительный раздел (заглушка 61)


<!-- auto-added example blocks to match EN structure -->
```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```
