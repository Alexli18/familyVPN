# Конфигурация веб-интерфейса

Семейный VPN-сервер включает веб-интерфейс управления для удобного управления сертификатами и администрирования сервера.

## Обзор

Веб-интерфейс предоставляет:
- Удобное создание и управление сертификатами
- Безопасную аутентификацию с управлением сессиями
- Возможности загрузки и отзыва сертификатов
- Мониторинг состояния сервера

## Предварительные требования

Перед настройкой веб-интерфейса:
- VPN-сервер должен быть установлен и запущен
- Переменные окружения должны быть настроены
- SSL-сертификаты рекомендуются для производственного использования

## Базовая конфигурация

### Переменные окружения

Веб-интерфейс требует настройки специфических переменных окружения:

#### Обязательные переменные
```bash
# Безопасность сессий
WEB_SESSION_SECRET=ваш-секретный-ключ

# Учетные данные для аутентификации
WEB_ADMIN_USERNAME=admin
WEB_ADMIN_PASSWORD_HASH=$2b$10$...  # bcrypt хеш вашего пароля

# Конфигурация сервера
PORT=3000                        # Порт веб-интерфейса
```

#### Опциональные переменные
```bash
# Настройки окружения
NODE_ENV=development              # Отключает принуждение HTTPS
WEB_HTTPS_ONLY=true              # Принуждает HTTPS даже в разработке
WEB_SESSION_TIMEOUT=1800000      # Таймаут сессии в миллисекундах (30 мин по умолчанию)

# Настройки сервера
VPN_HOST=ip-вашего-сервера       # Адрес VPN-сервера
API_PORT=3000                    # Порт API-сервера
```

### Создание учетных данных администратора

Для настройки аутентификации администратора:

1. **Создание хеша пароля**:
   ```bash
   npm run setup-web-admin
   ```

2. **Или создание хеша вручную**:
   ```bash
   node -e "console.log(require('bcrypt').hashSync('ваш-пароль', 10))"
   ```

3. **Добавление в окружение**:
   ```bash
   echo "WEB_ADMIN_PASSWORD_HASH=\$2b\$10\$..." >> .env
   ```

## Запуск веб-интерфейса

### Режим разработки (Рекомендуется для тестирования)

Для локальной разработки и тестирования:

```bash
npm run dev
# или
npm run web:dev
```

**Особенности режима разработки**:
- Принуждение HTTPS **отключено**
- Доступ по: http://localhost:3000
- Хранилище сессий использует память (не постоянное)
- Включено подробное логирование
- Горячая перезагрузка для разработки

### Производственный режим

Для производственного развертывания:

```bash
npm start
# или 
npm run web:start
```

**Особенности производственного режима**:
- Принуждение HTTPS **включено**
- Автоматическое перенаправление HTTP на HTTPS
- Доступ по: https://localhost:3000 (требует SSL-сертификат)
- Постоянное хранилище сессий
- Улучшенная конфигурация безопасности

## Доступ к веб-интерфейсу

1. **Запуск сервера**:
   ```bash
   npm run dev  # для разработки
   # или
   npm start    # для производства
   ```

2. **Открытие браузера**:
   ```
   # Разработка
   http://localhost:3000
   
   # Производство
   https://адрес-вашего-сервера:3000
   ```

3. **Вход в систему**:
   - Вы будете перенаправлены на `/login`
   - Введите учетные данные администратора
   - Получите доступ к интерфейсу управления сертификатами

## Конфигурация безопасности

### Система аутентификации

Веб-интерфейс использует аутентификацию на основе сессий:

- **Управление сессиями**: Безопасные cookies сессий с настраиваемым таймаутом
- **Безопасность паролей**: bcrypt хешированные пароли с солью
- **Ограничение скорости**: Защита от атак перебора
- **Защита CSRF**: Защита от межсайтовой подделки запросов

### Конфигурация HTTPS

#### HTTPS для разработки (Опционально)

Для разработки с HTTPS:

```bash
# Создание самоподписанных сертификатов
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# Установка переменной окружения
export WEB_HTTPS_ONLY=true

# Запуск с HTTPS
npm run dev
```

#### HTTPS для производства (Рекомендуется)

Для производства используйте правильные SSL-сертификаты:

1. **Получение SSL-сертификата** (Let's Encrypt, коммерческий CA и т.д.)
2. **Настройка путей к сертификатам**:
   ```bash
   export SSL_CERT_PATH=/путь/к/certificate.crt
   export SSL_KEY_PATH=/путь/к/private.key
   ```
3. **Включение принуждения HTTPS**:
   ```bash
   export NODE_ENV=production
   export WEB_HTTPS_ONLY=true
   ```

### Заголовки безопасности

Веб-интерфейс автоматически применяет заголовки безопасности:

- **Content Security Policy (CSP)**
- **X-Frame-Options**: Предотвращает clickjacking
- **X-Content-Type-Options**: Предотвращает MIME sniffing
- **Strict-Transport-Security**: Принуждение HTTPS
- **X-XSS-Protection**: Предотвращение XSS-атак

## Функции и использование

### Управление сертификатами

Веб-интерфейс предоставляет:

1. **Создание новых сертификатов**:
   - Ввод уникального имени клиента
   - Автоматическое создание сертификата
   - Немедленная загрузка файла `.ovpn`

2. **Просмотр существующих сертификатов**:
   - Список всех созданных сертификатов
   - Статус сертификатов и даты истечения
   - Загрузка существующих конфигураций

3. **Отзыв сертификатов**:
   - Отзыв скомпрометированных или неиспользуемых сертификатов
   - Обновление списка отозванных сертификатов (CRL)
   - Немедленное влияние на доступ к VPN

### Мониторинг сервера

Доступ к информации о сервере:
- **Статус сервера**: Здоровье и время работы VPN-сервера
- **Подключенные клиенты**: Текущие подключенные пользователи
- **Статистика сертификатов**: Общее количество сертификатов и статус
- **Системные ресурсы**: Базовая информация о системе

## Интеграция с API

Веб-интерфейс работает вместе с существующим API:

- **Веб-интерфейс**: `http://localhost:3000/`
- **API-эндпоинты**: `http://localhost:3000/api/*`
- **Проверка здоровья**: `http://localhost:3000/health`
- **Метрики**: `http://localhost:3000/metrics`

### Совместимость аутентификации

Обе системы аутентификации работают независимо:
- **Веб-интерфейс**: Аутентификация на основе сессий с cookies
- **API**: Аутентификация на основе JWT-токенов с заголовками

## Устранение неполадок

### Распространенные проблемы

#### Ошибки SSL/HTTPS

**Проблема**: "This site can't provide a secure connection" или ошибки SSL

**Решения**:
1. **Использование режима разработки**:
   ```bash
   npm run dev
   ```
2. **Проверка отключения принуждения HTTPS**:
   ```
   HTTPS enforcement disabled for development
   ```
3. **Использование HTTP в разработке**:
   ```
   http://localhost:3000  ✅ Правильно
   https://localhost:3000 ❌ Вызовет ошибки SSL в режиме разработки
   ```

#### Проблемы с аутентификацией

**Проблема**: Невозможно войти или аутентификация не удается

**Решения**:
1. **Проверка переменных окружения**:
   ```bash
   echo $WEB_ADMIN_USERNAME
   echo $WEB_ADMIN_PASSWORD_HASH
   ```
2. **Пересоздание хеша пароля**:
   ```bash
   npm run setup-web-admin
   ```
3. **Проверка конфигурации сессии**:
   ```bash
   echo $WEB_SESSION_SECRET
   ```

#### Конфликты портов

**Проблема**: Порт 3000 уже используется

**Решения**:
1. **Использование другого порта**:
   ```bash
   PORT=3001 npm run dev
   ```
2. **Поиск и остановка конфликтующего процесса**:
   ```bash
   lsof -ti:3000 | xargs kill -9
   ```

#### Проблемы с сессиями

**Проблема**: Частые выходы из системы или таймауты сессий

**Решения**:
1. **Увеличение таймаута сессии**:
   ```bash
   export WEB_SESSION_TIMEOUT=3600000  # 1 час
   ```
2. **Проверка секрета сессии**:
   ```bash
   # Убедитесь, что WEB_SESSION_SECRET установлен и согласован
   echo $WEB_SESSION_SECRET
   ```

### Отладочная конфигурация

Включение отладочного логирования:

```bash
# Отладка веб-интерфейса
DEBUG=web:* npm start

# Отладка сессий
DEBUG=express-session npm start

# Отладка всего
DEBUG=* npm start
```

## Расширенная конфигурация

### Пользовательские стили

Настройка внешнего вида веб-интерфейса:

1. **Изменение CSS**:
   ```bash
   # Редактирование стилей
   vim src/public/css/styles.css
   ```

2. **Добавление пользовательского логотипа**:
   ```bash
   # Замена файла логотипа
   cp ваш-логотип.png src/public/images/logo.png
   ```

### Настройка обратного прокси

Для производственного развертывания за обратным прокси:

#### Конфигурация Nginx
```nginx
server {
    listen 443 ssl;
    server_name ваш-домен.com;
    
    ssl_certificate /путь/к/certificate.crt;
    ssl_certificate_key /путь/к/private.key;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### Конфигурация Apache
```apache
<VirtualHost *:443>
    ServerName ваш-домен.com
    
    SSLEngine on
    SSLCertificateFile /путь/к/certificate.crt
    SSLCertificateKeyFile /путь/к/private.key
    
    ProxyPreserveHost On
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    ProxyPassReverse / http://localhost:3000/
    ProxyPassReverseMatch ^(/.*) http://localhost:3000$1
</VirtualHost>
```

### Конфигурация для конкретных окружений

#### Окружение разработки
```bash
# .env.development
NODE_ENV=development
WEB_HTTPS_ONLY=false
LOG_LEVEL=debug
WEB_SESSION_TIMEOUT=86400000  # 24 часа для разработки
```

#### Производственное окружение
```bash
# .env.production
NODE_ENV=production
WEB_HTTPS_ONLY=true
LOG_LEVEL=info
WEB_SESSION_TIMEOUT=1800000   # 30 минут для безопасности
```

## Лучшие практики безопасности

### Контрольный список безопасности для производства

- [ ] **Использование HTTPS**: Всегда включайте HTTPS в производстве
- [ ] **Сильные пароли**: Используйте сложные пароли администратора
- [ ] **Безопасность сессий**: Настройте соответствующие таймауты сессий
- [ ] **Регулярные обновления**: Поддерживайте зависимости в актуальном состоянии
- [ ] **Контроль доступа**: Ограничьте доступ к интерфейсу управления
- [ ] **Мониторинг**: Включите логирование и мониторинг
- [ ] **Резервное копирование**: Регулярное резервное копирование конфигурации и сертификатов

### Сетевая безопасность

1. **Конфигурация брандмауэра**:
   ```bash
   # Разрешить только необходимые порты
   sudo ufw allow 1194/udp  # VPN
   sudo ufw allow 3000/tcp  # Веб-интерфейс (или используйте обратный прокси)
   ```

2. **Ограничение доступа**:
   ```bash
   # Ограничить веб-интерфейс определенными IP
   sudo ufw allow from 192.168.1.0/24 to any port 3000
   ```

## Следующие шаги

После настройки веб-интерфейса:

1. **Тестирование функциональности**: Создайте и загрузите тестовый сертификат
2. **Настройка SSL**: Установите правильные SSL-сертификаты для производства
3. **Настройка мониторинга**: Настройте логирование и мониторинг
4. **Обучение пользователей**: Обучите пользователей управлению сертификатами
5. **Обзор безопасности**: Просмотрите и усильте настройки безопасности

## Связанная документация

- **[Конфигурация аутентификации](security.md#настройка-аутентификации)**
- **[Управление сертификатами](certificates.md)**
- **[Лучшие практики безопасности](../security/best-practices.md)**
- **[Устранение неполадок веб-интерфейса](../troubleshooting/common-issues.md#проблемы-веб-интерфейса)**

<!-- auto-added placeholders to match EN structure -->

## Дополнительный раздел (заглушка 1)


## Дополнительный раздел (заглушка 2)
