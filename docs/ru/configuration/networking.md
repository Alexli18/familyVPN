# Конфигурация сети

Это руководство охватывает конфигурацию сети для семейного VPN-сервера, включая VPN сети, маршрутизацию, настройку брандмауэра и оптимизацию производительности.

## Обзор

Конфигурация сети критически важна для правильной работы VPN. Это включает настройку подсети VPN, конфигурацию маршрутизации, управление правилами брандмауэра и оптимизацию производительности сети.

## Конфигурация VPN сети

### Базовые сетевые настройки

#### Конфигурация подсети VPN
```env
# Сетевые настройки в файле .env
VPN_SUBNET=10.8.0.0          # Адрес VPN сети
VPN_NETMASK=255.255.255.0    # Маска сети (/24)
VPN_PORT=1194                # Порт OpenVPN (UDP)
VPN_PROTOCOL=udp             # Протокол (рекомендуется udp)
```

#### Альтернативные варианты подсетей
```env
# Если 10.8.0.0/24 конфликтует с локальной сетью
VPN_SUBNET=10.9.0.0          # Альтернативная подсеть
VPN_SUBNET=172.16.0.0        # Частный диапазон класса B
VPN_SUBNET=192.168.100.0     # Частный диапазон класса C

# Большие сети (для большего количества клиентов)
VPN_SUBNET=10.8.0.0
VPN_NETMASK=255.255.0.0      # Сеть /16 (65,534 хоста)
```

#### Обнаружение конфликтов сети
```bash
# Проверка конфигурации локальной сети
ip route show
route -n

# Проверка конфликтов
ping -c 1 10.8.0.1  # Должно завершиться неудачей, если нет конфликта

# Поиск доступных подсетей
for i in {8..20}; do
  if ! ping -c 1 -W 1 10.$i.0.1 >/dev/null 2>&1; then
    echo "10.$i.0.0/24 кажется доступной"
  fi
done
```

### Конфигурация сети OpenVPN

#### Базовая конфигурация OpenVPN
```conf
# /etc/openvpn/openvpn.conf или ~/.privatevpn/config/openvpn.conf

# Режим сервера и сеть
mode server
tls-server

# Сетевые настройки
port 1194
proto udp
dev tun

# VPN сеть
server 10.8.0.0 255.255.255.0

# Конфигурация клиента
ifconfig-pool-persist ipp.txt
client-config-dir ccd

# Маршрутизация
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 1.1.1.1"
push "dhcp-option DNS 1.0.0.1"

# Поддержание соединения
keepalive 10 120

# Сжатие (опционально, может снизить производительность)
compress lz4-v2
push "compress lz4-v2"
```

### Конфигурация DNS

#### Варианты DNS серверов
```conf
# Безопасные DNS провайдеры
push "dhcp-option DNS 1.1.1.1"      # Cloudflare
push "dhcp-option DNS 1.0.0.1"      # Cloudflare вторичный
push "dhcp-option DNS 8.8.8.8"      # Google
push "dhcp-option DNS 8.8.4.4"      # Google вторичный
push "dhcp-option DNS 9.9.9.9"      # Quad9
push "dhcp-option DNS 149.112.112.112"  # Quad9 вторичный

# Локальный DNS (если запущен локальный DNS сервер)
push "dhcp-option DNS 192.168.1.1"  # Роутер/локальный DNS
```

## Конфигурация маршрутизации

### IP Forwarding

#### Включение IP Forwarding
```bash
# Временно (до перезагрузки)
sudo sysctl -w net.ipv4.ip_forward=1

# Постоянно
echo 'net.ipv4.ip_forward=1' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# Проверка
cat /proc/sys/net/ipv4/ip_forward  # Должно выводить 1
```

### Конфигурация NAT

#### Базовая настройка NAT
```bash
# Добавление правила NAT для VPN трафика
sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE

# Сделать постоянным (Ubuntu/Debian)
sudo iptables-save | sudo tee /etc/iptables/rules.v4

# Для других интерфейсов замените eth0 на ваш интерфейс
ip route | grep default  # Найти ваш интерфейс по умолчанию
```

## Конфигурация брандмауэра

### UFW (Ubuntu Firewall)

#### Базовая настройка UFW
```bash
# Сброс брандмауэра
sudo ufw --force reset

# Политики по умолчанию
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Разрешить SSH
sudo ufw allow ssh

# Разрешить OpenVPN
sudo ufw allow 1194/udp

# Разрешить веб-интерфейс (ограничить для админских IP)
sudo ufw allow from ВАШ_АДМИНСКИЙ_IP to any port 3000

# Включить брандмауэр
sudo ufw enable

# Проверить статус
sudo ufw status verbose
```

### Конфигурация iptables

#### Полная настройка iptables
```bash
#!/bin/bash
# Комплексная конфигурация iptables для VPN сервера

# Очистка существующих правил
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# Политики по умолчанию
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Разрешить loopback
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Разрешить установленные и связанные соединения
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# Разрешить SSH (настройте порт при необходимости)
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Разрешить OpenVPN
iptables -A INPUT -p udp --dport 1194 -j ACCEPT

# Разрешить веб-интерфейс только с админских IP
iptables -A INPUT -p tcp --dport 3000 -s ВАШ_АДМИНСКИЙ_IP -j ACCEPT

# Разрешить VPN клиентам доступ в интернет
iptables -A FORWARD -s 10.8.0.0/24 -j ACCEPT

# NAT для VPN клиентов
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE

# Сохранить правила
iptables-save > /etc/iptables/rules.v4
```

## Оптимизация производительности

### Настройка производительности сети

#### Оптимизация системной сети
```bash
# Увеличение размеров сетевых буферов
echo 'net.core.rmem_max = 134217728' | sudo tee -a /etc/sysctl.conf
echo 'net.core.wmem_max = 134217728' | sudo tee -a /etc/sysctl.conf
echo 'net.core.netdev_max_backlog = 5000' | sudo tee -a /etc/sysctl.conf

# Оптимизация TCP
echo 'net.ipv4.tcp_congestion_control = bbr' | sudo tee -a /etc/sysctl.conf
echo 'net.ipv4.tcp_rmem = 4096 87380 134217728' | sudo tee -a /etc/sysctl.conf
echo 'net.ipv4.tcp_wmem = 4096 65536 134217728' | sudo tee -a /etc/sysctl.conf

# Применить изменения
sudo sysctl -p
```

#### Оптимизация производительности OpenVPN
```conf
# Настройки производительности OpenVPN

# Использовать быстрый I/O
fast-io

# Увеличить размеры буферов
sndbuf 393216
rcvbuf 393216

# Оптимизировать для пропускной способности
tcp-nodelay

# Уменьшить использование CPU (отключить сжатие если не нужно)
# compress lz4-v2

# Оптимизировать TLS
tls-timeout 2
tls-retry 2
connect-timeout 10
connect-retry-max 3
```

## Мониторинг сети

### Мониторинг соединений

#### Мониторинг активных соединений
```bash
# Проверка статуса OpenVPN
sudo systemctl status openvpn@server

# Просмотр подключенных клиентов
cat /var/log/openvpn/openvpn-status.log

# Мониторинг сетевого трафика
sudo netstat -i
sudo iftop -i tun0

# Проверка VPN интерфейса
ip addr show tun0
```

### Диагностика сети

#### Тестирование подключения
```bash
# Тест подключения к VPN серверу
ping -c 4 IP_ВАШЕГО_VPN_СЕРВЕРА

# Тест VPN порта
nmap -sU -p 1194 IP_ВАШЕГО_VPN_СЕРВЕРА

# Тест с VPN клиента
ping -c 4 10.8.0.1  # VPN шлюз
ping -c 4 8.8.8.8   # Подключение к интернету
nslookup google.com  # Разрешение DNS
```

## Устранение проблем с сетью

### Общие проблемы с сетью

#### VPN клиенты не могут подключиться
```bash
# Проверить, слушает ли OpenVPN
sudo netstat -ulnp | grep 1194

# Проверить брандмауэр
sudo ufw status
sudo iptables -L -n | grep 1194

# Проверить логи OpenVPN
sudo tail -f /var/log/openvpn/openvpn.log

# Тест доступности порта
nmap -sU -p 1194 localhost
```

#### Нет доступа в интернет через VPN
```bash
# Проверить IP forwarding
cat /proc/sys/net/ipv4/ip_forward

# Проверить правила NAT
sudo iptables -t nat -L -n -v

# Проверить маршрутизацию
ip route show

# Тест DNS
dig @8.8.8.8 google.com
```

## Следующие шаги

После настройки сети:

1. **[Конфигурация сертификатов](certificates.md)** - Настройка PKI и сертификатов
2. **[Усиление безопасности](security.md#firewall-configuration)** - Расширенные настройки безопасности
3. **[Мониторинг производительности](../troubleshooting/performance.md)** - Мониторинг и оптимизация производительности

<!-- auto-added placeholders to match EN structure -->

## Дополнительный раздел (заглушка 1)


## Дополнительный раздел (заглушка 2)


## Дополнительный раздел (заглушка 3)


## Дополнительный раздел (заглушка 4)


## Дополнительный раздел (заглушка 5)


## Дополнительный раздел (заглушка 6)


## Дополнительный раздел (заглушка 7)


## Дополнительный раздел (заглушка 8)


## Дополнительный раздел (заглушка 9)


## Дополнительный раздел (заглушка 10)


## Дополнительный раздел (заглушка 11)


## Дополнительный раздел (заглушка 12)


## Дополнительный раздел (заглушка 13)


## Дополнительный раздел (заглушка 14)


## Дополнительный раздел (заглушка 15)


## Дополнительный раздел (заглушка 16)


## Дополнительный раздел (заглушка 17)


## Дополнительный раздел (заглушка 18)


## Дополнительный раздел (заглушка 19)


## Дополнительный раздел (заглушка 20)


## Дополнительный раздел (заглушка 21)


## Дополнительный раздел (заглушка 22)


## Дополнительный раздел (заглушка 23)


## Дополнительный раздел (заглушка 24)


## Дополнительный раздел (заглушка 25)


## Дополнительный раздел (заглушка 26)


## Дополнительный раздел (заглушка 27)


## Дополнительный раздел (заглушка 28)


## Дополнительный раздел (заглушка 29)


## Дополнительный раздел (заглушка 30)


## Дополнительный раздел (заглушка 31)


## Дополнительный раздел (заглушка 32)


## Дополнительный раздел (заглушка 33)


## Дополнительный раздел (заглушка 34)


## Дополнительный раздел (заглушка 35)


## Дополнительный раздел (заглушка 36)


## Дополнительный раздел (заглушка 37)


## Дополнительный раздел (заглушка 38)


## Дополнительный раздел (заглушка 39)


## Дополнительный раздел (заглушка 40)


## Дополнительный раздел (заглушка 41)


## Дополнительный раздел (заглушка 42)


## Дополнительный раздел (заглушка 43)


## Дополнительный раздел (заглушка 44)


## Дополнительный раздел (заглушка 45)


## Дополнительный раздел (заглушка 46)


## Дополнительный раздел (заглушка 47)


## Дополнительный раздел (заглушка 48)


## Дополнительный раздел (заглушка 49)


## Дополнительный раздел (заглушка 50)


## Дополнительный раздел (заглушка 51)


## Дополнительный раздел (заглушка 52)


## Дополнительный раздел (заглушка 53)


## Дополнительный раздел (заглушка 54)


## Дополнительный раздел (заглушка 55)


## Дополнительный раздел (заглушка 56)


## Дополнительный раздел (заглушка 57)


## Дополнительный раздел (заглушка 58)


## Дополнительный раздел (заглушка 59)


## Дополнительный раздел (заглушка 60)


## Дополнительный раздел (заглушка 61)


## Дополнительный раздел (заглушка 62)


## Дополнительный раздел (заглушка 63)


## Дополнительный раздел (заглушка 64)


## Дополнительный раздел (заглушка 65)


## Дополнительный раздел (заглушка 66)


## Дополнительный раздел (заглушка 67)


## Дополнительный раздел (заглушка 68)


## Дополнительный раздел (заглушка 69)


## Дополнительный раздел (заглушка 70)


## Дополнительный раздел (заглушка 71)


## Дополнительный раздел (заглушка 72)


## Дополнительный раздел (заглушка 73)


## Дополнительный раздел (заглушка 74)


## Дополнительный раздел (заглушка 75)


## Дополнительный раздел (заглушка 76)


## Дополнительный раздел (заглушка 77)


## Дополнительный раздел (заглушка 78)


## Дополнительный раздел (заглушка 79)


## Дополнительный раздел (заглушка 80)


## Дополнительный раздел (заглушка 81)


## Дополнительный раздел (заглушка 82)


## Дополнительный раздел (заглушка 83)


## Дополнительный раздел (заглушка 84)


## Дополнительный раздел (заглушка 85)


## Дополнительный раздел (заглушка 86)


## Дополнительный раздел (заглушка 87)


## Дополнительный раздел (заглушка 88)


## Дополнительный раздел (заглушка 89)


## Дополнительный раздел (заглушка 90)


## Дополнительный раздел (заглушка 91)


## Дополнительный раздел (заглушка 92)


## Дополнительный раздел (заглушка 93)


## Дополнительный раздел (заглушка 94)


## Дополнительный раздел (заглушка 95)


## Дополнительный раздел (заглушка 96)


## Дополнительный раздел (заглушка 97)


## Дополнительный раздел (заглушка 98)


## Дополнительный раздел (заглушка 99)


## Дополнительный раздел (заглушка 100)


## Дополнительный раздел (заглушка 101)


## Дополнительный раздел (заглушка 102)


## Дополнительный раздел (заглушка 103)


<!-- auto-added example blocks to match EN structure -->
```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```
