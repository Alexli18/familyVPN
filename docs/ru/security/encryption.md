# Шифрование и криптографическая безопасность

## Обзор

Семейный VPN сервер реализует криптографическую безопасность корпоративного уровня, используя современные стандарты шифрования и лучшие практики. Этот документ охватывает все криптографические аспекты, включая VPN шифрование, управление сертификатами и безопасную обработку ключей.

## Конфигурация шифрования OpenVPN

### Конфигурация шифров

#### Основной шифр: AES-256-GCM
```
cipher AES-256-GCM
```

**Особенности**:
- **Алгоритм**: Advanced Encryption Standard (AES)
- **Размер ключа**: 256-битные ключи для максимальной безопасности
- **Режим**: Galois/Counter Mode (GCM) для аутентифицированного шифрования
- **Производительность**: Аппаратное ускорение на современных процессорах
- **Безопасность**: Обеспечивает как конфиденциальность, так и аутентичность

#### Резервный шифр: AES-256-CBC
```
cipher AES-256-CBC
auth SHA256
```

**Особенности**:
- **Совместимость**: Более широкая поддержка клиентов
- **Аутентификация**: SHA-256 HMAC для аутентификации сообщений
- **Безопасность**: Сильное шифрование с отдельной аутентификацией

### Алгоритмы аутентификации

#### Аутентификация сообщений
```
auth SHA256
```

**Свойства**:
- **Алгоритм**: SHA-256 (Secure Hash Algorithm)
- **Размер вывода**: 256-битный хеш
- **Безопасность**: Криптографически безопасная хеш-функция
- **Производительность**: Доступны оптимизированные реализации

#### TLS аутентификация
```
tls-auth ta.key 0
# или
tls-crypt ta.key
```

**Преимущества TLS-Crypt**:
- **Дополнительное шифрование**: Шифрование канала управления
- **Защита от повторов**: Встроенная защита от атак повтора
- **Смягчение DDoS**: Фильтрация недействительных пакетов на раннем этапе
- **Perfect Forward Secrecy**: Улучшенная безопасность ключей

### Обмен ключами и Perfect Forward Secrecy

#### Параметры Diffie-Hellman
```
dh dh2048.pem
```

**Конфигурация**:
- **Размер ключа**: Минимум 2048-бит (рекомендуется 4096-бит)
- **Генерация**: Криптографически безопасная случайная генерация
- **Назначение**: Безопасный обмен ключами для сессионных ключей

#### Эллиптическая криптография
```
ecdh-curve prime256v1
```

**Преимущества**:
- **Производительность**: Быстрее традиционного DH
- **Безопасность**: Эквивалентная безопасность с меньшими ключами
- **Современный стандарт**: Кривая NIST P-256

### Конфигурация TLS

#### Требования к версии TLS
```
tls-version-min 1.2
tls-version-max 1.3
```

**Функции безопасности**:
- **Минимум TLS 1.2**: Исключает слабые протоколы
- **Поддержка TLS 1.3**: Последние улучшения безопасности
- **Безопасность протокола**: Выбор сильных наборов шифров

#### Проверка сертификатов
```
remote-cert-tls client
verify-client-cert require
```

**Процесс проверки**:
- **Цепочка сертификатов**: Полная валидация цепочки
- **Назначение сертификата**: Валидация клиентского сертификата
- **Проверка отзыва**: Проверка CRL
- **Common Name**: Валидация CN (опционально)

## Шифрование управления сертификатами

### PKI инфраструктура

#### Центр сертификации (CA)
- **Алгоритм ключа**: RSA или ECDSA
- **Размер ключа**: 4096-бит RSA или P-384 ECDSA
- **Алгоритм подписи**: SHA-256
- **Период действия**: 10 лет (настраивается)

#### Серверные сертификаты
- **Алгоритм ключа**: RSA минимум 2048-бит
- **Алгоритм подписи**: SHA-256 с RSA
- **Использование ключа**: Цифровая подпись, шифрование ключей
- **Расширенное использование ключа**: TLS аутентификация веб-сервера

#### Клиентские сертификаты
- **Алгоритм ключа**: RSA минимум 2048-бит
- **Алгоритм подписи**: SHA-256 с RSA
- **Использование ключа**: Цифровая подпись
- **Расширенное использование ключа**: TLS аутентификация веб-клиента

### Функции безопасности сертификатов

#### Генерация сильных ключей
```bash
# Генерация RSA ключа
openssl genrsa -out private.key 2048

# Генерация ECDSA ключа (альтернатива)
openssl ecparam -genkey -name prime256v1 -out private.key
```

#### Безопасная подпись сертификатов
```bash
# Подпись сертификата с SHA-256
openssl ca -config openssl.cnf \
  -extensions client_cert \
  -days 365 \
  -notext \
  -md sha256 \
  -in client.csr \
  -out client.crt
```

#### Валидация сертификатов
- **Валидация цепочки**: Полная проверка цепочки сертификатов
- **Проверка истечения**: Автоматический мониторинг истечения
- **Проверка отзыва**: Проверка отзыва на основе CRL
- **Валидация использования ключа**: Правильное принуждение использования ключа

### Отзыв сертификатов

#### Список отзыва сертификатов (CRL)
```
crl-verify crl.pem
```

**Особенности**:
- **Автоматические обновления**: Регулярная регенерация CRL
- **Причины отзыва**: Детальное отслеживание отзыва
- **Распространение**: Безопасное распространение CRL
- **Валидация**: Проверка отзыва в реальном времени

#### Поддержка OCSP (будущее улучшение)
- **Валидация в реальном времени**: Онлайн проверка статуса сертификата
- **Производительность**: Быстрее CRL для больших развертываний
- **Приватность**: Улучшенная защита приватности

## Шифрование паролей и токенов

### bcrypt хеширование паролей

#### Конфигурация
```javascript
const saltRounds = 12;
const hash = bcrypt.hashSync(password, saltRounds);
```

**Свойства безопасности**:
- **Алгоритм**: bcrypt (на основе Blowfish)
- **Раунды соли**: 12 (настраивается, минимум 10)
- **Уникальные соли**: Каждый пароль получает уникальную соль
- **Устойчивость к атакам по времени**: Сравнение с постоянным временем

#### Функции безопасности
- **Адаптивное хеширование**: Настраиваемый фактор работы
- **Генерация соли**: Криптографически безопасные случайные соли
- **Проверка хеша**: Безопасные функции сравнения
- **Перспективность**: Регулируемая сложность со временем

### Безопасность JWT токенов

#### Подпись токенов
```javascript
const token = jwt.sign(payload, secret, {
  algorithm: 'HS256',
  expiresIn: '15m',
  issuer: 'family-vpn-server',
  audience: 'vpn-api'
});
```

**Криптографические свойства**:
- **Алгоритм**: HMAC-SHA256
- **Управление секретами**: Криптографически сильные секреты
- **Структура токена**: Стандартный формат JWT
- **Проверка подписи**: Строгая валидация подписи

#### Управление секретами
- **Генерация секретов**: Криптографически безопасная случайная генерация
- **Хранение секретов**: Защита переменными окружения
- **Ротация секретов**: Возможность регулярной ротации секретов
- **Множественные секреты**: Отдельные секреты для токенов доступа и обновления

## Генерация случайных чисел

### Источники энтропии

#### Системная энтропия
- **Linux**: `/dev/urandom` для криптографической случайности
- **Windows**: CryptGenRandom API
- **macOS**: SecRandomCopyBytes framework

#### Модуль Node.js Crypto
```javascript
const crypto = require('crypto');

// Генерация криптографически безопасных случайных байтов
const randomBytes = crypto.randomBytes(32);

// Генерация случайного UUID
const uuid = crypto.randomUUID();
```

### Генерация ключей

#### Симметричные ключи
```javascript
// Генерация AES-256 ключа
const aesKey = crypto.randomBytes(32); // 256 бит

// Генерация HMAC ключа
const hmacKey = crypto.randomBytes(64); // 512 бит
```

#### Асимметричные пары ключей
```javascript
// Генерация RSA пары ключей
const { publicKey, privateKey } = crypto.generateKeyPairSync('rsa', {
  modulusLength: 2048,
  publicKeyEncoding: { type: 'spki', format: 'pem' },
  privateKeyEncoding: { type: 'pkcs8', format: 'pem' }
});
```

## Лучшие криптографические практики

### Управление ключами

#### Хранение ключей
- **Приватные ключи**: Ограниченные разрешения файлов (600)
- **Приватный ключ CA**: Офлайн хранение когда возможно
- **Симметричные ключи**: Защита переменными окружения
- **Резервное копирование ключей**: Безопасные зашифрованные резервные копии

#### Ротация ключей
- **JWT секреты**: Рекомендуется ежемесячная ротация
- **TLS сертификаты**: Ежегодное обновление
- **CA сертификат**: 10-летняя действительность с мониторингом
- **DH параметры**: Регенерация ежегодно

### Выбор алгоритмов

#### Одобренные алгоритмы
- **Симметричное шифрование**: AES-256-GCM, AES-256-CBC
- **Асимметричное шифрование**: RSA-2048+, ECDSA P-256+
- **Хеш-функции**: SHA-256, SHA-384, SHA-512
- **Обмен ключами**: ECDH P-256+, DH 2048+
- **Аутентификация сообщений**: HMAC-SHA256+

#### Устаревшие алгоритмы
- ❌ **DES/3DES**: Слабое шифрование
- ❌ **RC4**: Уязвимости потокового шифра
- ❌ **MD5**: Уязвимости коллизий хеша
- ❌ **SHA-1**: Уязвимости коллизий
- ❌ **RSA-1024**: Недостаточная длина ключа

### Безопасность реализации

#### Практики безопасного кодирования
- **Операции с постоянным временем**: Предотвращение атак по времени
- **Безопасная память**: Очистка чувствительных данных из памяти
- **Валидация входных данных**: Валидация всех криптографических входных данных
- **Обработка ошибок**: Безопасные сообщения об ошибках
- **Защита от боковых каналов**: Смягчение атак по боковым каналам

#### Выбор библиотек
- **OpenSSL**: Криптографическая библиотека промышленного стандарта
- **Node.js Crypto**: Встроенные криптографические функции
- **bcrypt**: Проверенная библиотека хеширования паролей
- **jsonwebtoken**: Безопасная реализация JWT

## Конфигурация шифрования

### Конфигурация сервера OpenVPN

```
# Конфигурация сильного шифрования
cipher AES-256-GCM
auth SHA256
tls-crypt ta.key
tls-version-min 1.2
ecdh-curve prime256v1
dh dh2048.pem

# Проверка сертификатов
remote-cert-tls client
verify-client-cert require
crl-verify crl.pem

# Дополнительная безопасность
topology subnet
compress lz4-v2
```

### Конфигурация клиента

```
# Настройки шифрования на стороне клиента
cipher AES-256-GCM
auth SHA256
tls-client
remote-cert-tls server
verify-x509-name server_name name

# Улучшения безопасности
auth-nocache
compress lz4-v2
```

## Криптографическое тестирование

### Тесты шифрования

```bash
# Тест шифрования OpenVPN
npm run test:encryption

# Тест валидации сертификатов
npm run test:certificates

# Тест безопасности паролей
npm run test:password-security
```

### Ручная криптографическая проверка

#### Тест цепочки сертификатов
```bash
# Проверка цепочки сертификатов
openssl verify -CAfile ca.crt -untrusted intermediate.crt client.crt

# Проверка деталей сертификата
openssl x509 -in client.crt -text -noout
```

#### Тест силы шифрования
```bash
# Тест силы шифра
openssl ciphers -v 'AES256-GCM-SHA384'

# Тест силы ключа
openssl rsa -in private.key -text -noout | grep "Private-Key"
```

## Соображения производительности

### Аппаратное ускорение

#### Поддержка AES-NI
- **Intel/AMD**: Аппаратное ускорение AES
- **ARM**: Криптографические расширения
- **Производительность**: Улучшение в 5-10 раз по сравнению с программным
- **Проверка**: Проверить флаги CPU для поддержки AES

#### Настройки оптимизации
```bash
# Проверка поддержки AES-NI
grep -m1 -o aes /proc/cpuinfo

# Настройка производительности OpenVPN
fast-io
sndbuf 0
rcvbuf 0
```

### Производительность шифров

| Шифр | Безопасность | Производительность | Рекомендация |
|------|-------------|-------------------|--------------|
| AES-256-GCM | Отличная | Очень хорошая | Основной выбор |
| AES-256-CBC | Отличная | Хорошая | Резервный вариант |
| ChaCha20-Poly1305 | Отличная | Хорошая | Мобильные устройства |

## Соответствие и стандарты

### Криптографические стандарты

#### Руководства NIST
- **FIPS 140-2**: Стандарты криптографических модулей
- **SP 800-57**: Рекомендации по управлению ключами
- **SP 800-131A**: Переходы криптографических алгоритмов

#### Отраслевые стандарты
- **RFC 5246**: Спецификация TLS 1.2
- **RFC 8446**: Спецификация TLS 1.3
- **RFC 7539**: Спецификация ChaCha20-Poly1305
- **RFC 3526**: Спецификации DH групп

### Сертификации безопасности

#### Common Criteria
- **Профили защиты**: Профили защиты VPN шлюзов
- **Гарантия оценки**: Стандарты оценки безопасности
- **Сертификация**: Валидация безопасности третьей стороной

## Устранение проблем с шифрованием

### Общие проблемы

#### Несоответствие шифров
- **Симптом**: Соединение не удается с ошибками шифра
- **Причина**: Несоответствие шифров клиент/сервер
- **Решение**: Проверить конфигурацию шифров на обеих сторонах

#### Ошибки валидации сертификатов
- **Симптом**: Сбои проверки сертификатов
- **Причина**: Недействительные сертификаты, истекший CRL, расхождение часов
- **Решение**: Проверить действительность сертификата, обновить CRL, синхронизировать время

#### Проблемы производительности
- **Симптом**: Медленная производительность VPN
- **Причина**: Программное шифрование, слабое оборудование
- **Решение**: Включить аппаратное ускорение, оптимизировать настройки

### Инструменты отладки

```bash
# Отладка OpenVPN
openvpn --config client.ovpn --verb 4

# Отладка сертификатов
openssl verify -verbose -CAfile ca.crt client.crt

# Тестирование шифров
openssl speed aes-256-gcm
```

## Связанная документация

- [Обзор безопасности](overview.md) - Полная архитектура безопасности
- [Система аутентификации](authentication.md) - Аутентификация и безопасность сессий
- [Мониторинг безопасности](monitoring.md) - Мониторинг криптографических событий
- [Лучшие практики](best-practices.md) - Криптографические лучшие практики
- [Управление сертификатами](../configuration/certificates.md) - Конфигурация сертификатов