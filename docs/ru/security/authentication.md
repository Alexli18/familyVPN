# Система аутентификации

## Обзор

VPN сервер реализует надежную систему аутентификации, которая заменяет захардкоженные учетные данные на практики безопасности промышленного стандарта. Система использует JWT токены для доступа к API и аутентификацию на основе сессий для веб-интерфейса.

## Архитектура аутентификации

### Двойные системы аутентификации

Сервер поддерживает два независимых механизма аутентификации:

1. **JWT токен аутентификация**: Для доступа к API и программных взаимодействий
2. **Аутентификация на основе сессий**: Для доступа к веб-интерфейсу

Обе системы используют одно хранилище учетных данных, но работают независимо для максимальной гибкости.

## JWT токен аутентификация

### Типы токенов

#### Токены доступа
- **Время жизни**: 15 минут (настраивается)
- **Назначение**: Авторизация доступа к API
- **Хранение**: HTTP-only cookies или заголовок Authorization
- **Алгоритм**: HMAC-SHA256

#### Токены обновления
- **Время жизни**: 7 дней (настраивается)
- **Назначение**: Обновление токенов доступа
- **Хранение**: Безопасные HTTP-only cookies
- **Ротация**: Новый токен обновления выдается при каждом использовании

### Структура токена

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "admin",
    "iat": 1640995200,
    "exp": 1640996100,
    "iss": "family-vpn-server",
    "aud": "vpn-api"
  }
}
```

### Функции безопасности токенов

- **Безопасная подпись**: HMAC-SHA256 с криптографически сильными секретами
- **Валидация истечения**: Строгая проверка времени истечения
- **Валидация издателя**: Проверяет издателя и аудиторию токена
- **Безопасное хранение**: HTTP-only, secure, SameSite cookies

## Безопасность паролей

### bcrypt хеширование

Все пароли хешируются с использованием bcrypt со следующими параметрами:

- **Алгоритм**: bcrypt
- **Раунды соли**: 12 (настраивается)
- **Уникальные соли**: Каждый пароль получает уникальную соль
- **Защита от атак по времени**: Сравнение с постоянным временем

### Требования к паролям

- **Минимальная длина**: 8 символов (рекомендуется: 12+)
- **Сложность**: Смесь заглавных, строчных букв, цифр и символов
- **Никаких общих паролей**: Избегайте словарных слов и общих шаблонов
- **Регулярная ротация**: Меняйте пароли периодически

## Защита от атак грубой силы

### Ограничение скорости

Система реализует комплексное ограничение скорости:

#### Эндпоинты аутентификации
- **Попытки входа**: Максимум 5 попыток за 15 минут на IP
- **Прогрессивные задержки**: Увеличивающиеся задержки после неудачных попыток
- **Блокировка аккаунта**: Временная блокировка после 5 неудачных попыток
- **Отслеживание IP**: Неудачные попытки отслеживаются по комбинации имя пользователя/IP

#### API эндпоинты
- **Общий API**: 100 запросов за 15 минут на IP
- **Операции с сертификатами**: 10 запросов за 15 минут на IP
- **Системные операции**: 20 запросов за 15 минут на IP

### Механизм блокировки

```javascript
// Конфигурация блокировки
{
  maxFailedAttempts: 5,
  lockoutDuration: 900000, // 15 минут
  progressiveDelay: true,
  trackByIP: true,
  trackByUsername: true
}
```

### Функции защиты

- **Блокировка аккаунта**: Временная приостановка аккаунта
- **Блокировка по IP**: Блокировка подозрительных IP адресов
- **Прогрессивные задержки**: Увеличивающиеся задержки между попытками
- **Аудит логирование**: Полное логирование всех событий аутентификации

## Управление сессиями

### Сессии веб-интерфейса

#### Конфигурация сессий
- **Хранилище сессий**: На основе памяти (настраивается на Redis)
- **Время жизни сессии**: 24 часа (настраивается)
- **Секрет сессии**: Криптографически сильный случайный секрет
- **Безопасность cookies**: HTTP-only, secure, SameSite атрибуты

#### Функции безопасности сессий
- **Автоматическая очистка**: Удаление истекших сессий
- **Регенерация сессий**: Новый ID сессии при входе
- **Безопасные cookies**: Защита от XSS и CSRF
- **Валидация сессий**: Регулярные проверки целостности сессий

### Безопасность cookies

```javascript
// Конфигурация cookies
{
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  maxAge: 24 * 60 * 60 * 1000, // 24 часа
  signed: true
}
```

## Заголовки безопасности

### HTTP заголовки безопасности

Система автоматически применяет заголовки безопасности:

- **X-Content-Type-Options**: `nosniff`
- **X-Frame-Options**: `DENY`
- **X-XSS-Protection**: `1; mode=block`
- **Strict-Transport-Security**: `max-age=31536000; includeSubDomains`
- **Content-Security-Policy**: Ограничительная CSP политика
- **Referrer-Policy**: `strict-origin-when-cross-origin`

### Конфигурация CORS

```javascript
// Настройки CORS
{
  origin: process.env.ALLOWED_ORIGINS?.split(',') || false,
  credentials: true,
  optionsSuccessStatus: 200
}
```

## Настройка аутентификации

### Первоначальная конфигурация

1. **Запустить настройку аутентификации**:
   ```bash
   npm run setup-auth
   ```

2. **Настроить переменные окружения**:
   ```env
   # Учетные данные админа
   VPN_USERNAME=admin
   VPN_PASSWORD_HASH=bcrypt_hash_here
   
   # JWT конфигурация
   JWT_SECRET=secure_random_secret
   JWT_REFRESH_SECRET=secure_refresh_secret
   JWT_EXPIRY=15m
   JWT_REFRESH_EXPIRY=7d
   
   # Настройки безопасности
   MAX_FAILED_ATTEMPTS=5
   LOCKOUT_DURATION=900000
   ENFORCE_IP_VALIDATION=false
   ```

### Ручная генерация хеша пароля

```bash
# Генерация bcrypt хеша
node -e "
const bcrypt = require('bcrypt');
const password = 'your_secure_password';
const hash = bcrypt.hashSync(password, 12);
console.log('Password hash:', hash);
"
```

## API аутентификация

### Поток аутентификации

1. **Запрос входа**:
   ```bash
   curl -X POST http://localhost:3000/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username": "admin", "password": "your_password"}'
   ```

2. **Ответ**:
   ```json
   {
     "success": true,
     "message": "Authentication successful",
     "user": {
       "username": "admin"
     }
   }
   ```

3. **Использование токена**:
   ```bash
   curl -X GET http://localhost:3000/api/certificates \
     -H "Authorization: Bearer your_access_token"
   ```

### Обновление токена

```bash
curl -X POST http://localhost:3000/api/auth/refresh \
  -H "Content-Type: application/json" \
  --cookie "refreshToken=your_refresh_token"
```

## Мониторинг безопасности

### События аутентификации

Все события аутентификации логируются со структурированными данными:

```json
{
  "timestamp": "2025-01-15T10:30:00.000Z",
  "level": "info",
  "message": "Аутентификация успешна",
  "username": "admin",
  "clientIP": "192.168.1.100",
  "userAgent": "Mozilla/5.0...",
  "correlationId": "abc123-def456-ghi789"
}
```

### Логирование неудачной аутентификации

```json
{
  "timestamp": "2025-01-15T10:30:00.000Z",
  "level": "warn",
  "message": "Аутентификация не удалась",
  "username": "admin",
  "clientIP": "192.168.1.100",
  "error": "Неверные учетные данные",
  "attemptCount": 3,
  "correlationId": "abc123-def456-ghi789"
}
```

### Метрики мониторинга

Система отслеживает:
- **Успешные аутентификации**: Количество и скорость
- **Неудачные попытки аутентификации**: Количество, скорость и паттерны
- **Блокировки аккаунтов**: Частота и продолжительность
- **Генерация токенов**: Создание токенов доступа и обновления
- **Валидация токенов**: Показатели успеха и неудач
- **Активность сессий**: Создание, валидация и очистка

## Тестирование безопасности

### Тесты аутентификации

```bash
# Тест сервиса аутентификации
npm run test:auth

# Тест функций безопасности
npm run test:security

# Тест ограничения скорости
npm run test:rate-limiting
```

### Ручное тестирование безопасности

1. **Тест защиты от атак грубой силы**:
   ```bash
   # Множественные неудачные попытки входа
   for i in {1..10}; do
     curl -X POST http://localhost:3000/api/auth/login \
       -H "Content-Type: application/json" \
       -d '{"username": "admin", "password": "wrong_password"}'
   done
   ```

2. **Тест истечения токена**:
   ```bash
   # Ждем истечения токена и тестируем доступ
   sleep 900  # Ждем 15 минут
   curl -X GET http://localhost:3000/api/certificates \
     -H "Authorization: Bearer expired_token"
   ```

## Устранение неполадок

### Общие проблемы аутентификации

#### Неверные учетные данные
- **Симптом**: Ошибка "Authentication failed"
- **Причины**: Неправильное имя пользователя/пароль, заблокированный аккаунт
- **Решения**: Проверить учетные данные, проверить статус блокировки, сбросить пароль

#### Ошибки валидации токенов
- **Симптом**: Ошибки "Invalid token" или "Token expired"
- **Причины**: Истекшие токены, неверные подписи, расхождение часов
- **Решения**: Обновить токены, проверить JWT секреты, синхронизировать часы

#### Проблемы с сессиями
- **Симптом**: Частые выходы из системы, сессия не сохраняется
- **Причины**: Конфигурация cookies, проблемы с хранилищем сессий
- **Решения**: Проверить настройки cookies, проверить конфигурацию сессий

### Отладка аутентификации

1. **Проверить переменные окружения**:
   ```bash
   echo $VPN_USERNAME
   echo $JWT_SECRET
   ```

2. **Проверить хеш пароля**:
   ```bash
   node -e "
   const bcrypt = require('bcrypt');
   const hash = process.env.VPN_PASSWORD_HASH;
   const password = 'test_password';
   console.log('Valid:', bcrypt.compareSync(password, hash));
   "
   ```

3. **Проверить логи аутентификации**:
   ```bash
   tail -f logs/security-$(date +%Y-%m-%d).log | grep -i auth
   ```

## Лучшие практики

### Операционная безопасность

1. **Регулярные обновления паролей**: Меняйте пароли каждые 90 дней
2. **Ротация JWT секретов**: Ротируйте JWT секреты ежемесячно
3. **Мониторинг логов аутентификации**: Просматривайте логи еженедельно на предмет аномалий
4. **Управление аккаунтами**: Регулярный аудит пользовательских аккаунтов
5. **Очистка сессий**: Регулярная очистка истекших сессий

### Безопасность разработки

1. **Безопасные значения по умолчанию**: Используйте безопасную конфигурацию по умолчанию
2. **Валидация входных данных**: Валидируйте все входные данные аутентификации
3. **Обработка ошибок**: Общие сообщения об ошибках для безопасности
4. **Тестирование**: Комплексное тестирование безопасности
5. **Код-ревью**: Код-ревью с фокусом на безопасность

### Безопасность в продакшене

1. **Только HTTPS**: Принудительное использование HTTPS в продакшене
2. **Безопасные заголовки**: Включить все заголовки безопасности
3. **Ограничение скорости**: Реализовать агрессивное ограничение скорости
4. **Мониторинг**: Мониторинг аутентификации в реальном времени
5. **Резервное копирование**: Безопасное резервное копирование конфигурации аутентификации

## Связанная документация

- [Обзор безопасности](overview.md) - Полная архитектура безопасности
- [Шифрование и криптография](encryption.md) - Криптографическая безопасность
- [Мониторинг безопасности](monitoring.md) - Мониторинг и оповещения
- [Документация API](../api/authentication.md) - Детали аутентификации API
- [Лучшие практики](best-practices.md) - Лучшие практики безопасности