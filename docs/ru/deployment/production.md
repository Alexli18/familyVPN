# Лучшие практики продакшена

Это руководство охватывает развертывание семейного VPN сервера в продакшене с правильной безопасностью, мониторингом и практиками обслуживания.

## Быстрое продакшен развертывание

### Автоматизированный скрипт развертывания

```bash
# Развернуть в продакшене (запустить как root для настройки SSL)
sudo ./scripts/deploy-production.sh ваш-домен.com ваш-ip-сервера

# Или развернуть без SSL (требуется ручная настройка SSL)
./scripts/deploy-production.sh ваш-домен.com ваш-ip-сервера
```

### Ручные шаги продакшена

```bash
# 1. Обновить продакшен конфигурацию
cp .env.production.example .env.production
nano .env.production  # Обновить VPN_HOST и другие настройки

# 2. Настроить SSL сертификаты
sudo certbot certonly --standalone -d ваш-домен.com

# 3. Развернуть с Docker
docker-compose -f docker-compose.prod.yml up -d --build

# 4. Проверить развертывание
./scripts/monitor-production.sh
```

## Продакшен конфигурация

### Переменные окружения (.env.production)

```bash
# Обязательные настройки
VPN_HOST=ваш-домен.com                # Домен/IP вашего сервера
WEB_ADMIN_USERNAME=admin              # Имя пользователя веб-интерфейса
WEB_ADMIN_PASSWORD_HASH=...           # Bcrypt хеш пароля администратора

# Настройки безопасности
WEB_HTTPS_ONLY=true                   # Принудительный HTTPS
WEB_RATE_LIMIT_ENABLED=true          # Включить ограничение скорости
WEB_SESSION_SECRET=...                # Секрет сессии (64+ символов)
WEB_SESSION_TIMEOUT=1800000           # Таймаут сессии (30 минут)

# Конфигурация VPN сети
VPN_SUBNET=10.8.0.0                   # VPN подсеть
VPN_NETMASK=255.255.255.0             # VPN маска сети

# Конфигурация SSL
SSL_CERT=/etc/letsencrypt/live/ваш-домен.com/fullchain.pem
SSL_KEY=/etc/letsencrypt/live/ваш-домен.com/privkey.pem

# Логирование
LOG_LEVEL=info                        # Уровень логов продакшена
LOG_MAX_SIZE=10m                      # Максимальный размер файла логов
LOG_MAX_FILES=5                       # Количество файлов логов для хранения
```

## Функции безопасности

### Безопасность веб-интерфейса

- **Принудительный HTTPS**: Весь трафик зашифрован с SSL/TLS
- **Аутентификация**: Хеширование паролей Bcrypt с настраиваемой сложностью
- **Безопасность сессий**: Безопасные cookies с флагами HttpOnly и Secure
- **Ограничение скорости**: Настраиваемая защита от брутфорса
- **Защита CSRF**: Предотвращение межсайтовой подделки запросов
- **Защита XSS**: Валидация ввода и экранирование вывода
- **Заголовки безопасности**: HSTS, X-Frame-Options, X-Content-Type-Options

### Безопасность контейнера

- **Минимальные привилегии**: Работает только с необходимыми возможностями (NET_ADMIN)
- **Возможности безопасности**: Все ненужные возможности отброшены
- **Монтирование только для чтения**: SSL сертификаты монтируются только для чтения
- **Tmpfs**: Временные файлы хранятся в памяти
- **Мониторинг состояния**: Автоматический перезапуск при сбое
- **Без новых привилегий**: Предотвращает эскалацию привилегий

### Безопасность VPN

- **PKI инфраструктура**: Полный центр сертификации с Easy-RSA
- **Отзыв сертификатов**: Поддержка CRL для скомпрометированных сертификатов
- **Изоляция сети**: Выделенная VPN подсеть с правильной маршрутизацией
- **Шифрование**: Сильные наборы шифров и алгоритмы обмена ключами
- **Логирование**: Комплексный аудиторский след для всех подключений

## Конфигурация SSL/TLS

### Настройка Let's Encrypt

```bash
# Установить certbot
sudo apt install certbot

# Сгенерировать сертификат
sudo certbot certonly --standalone -d ваш-домен.com

# Проверить сертификат
sudo certbot certificates

# Тестировать автоматическое обновление
sudo certbot renew --dry-run

# Настроить автоматическое обновление
echo "0 3 * * * /usr/bin/certbot renew --quiet --deploy-hook 'docker-compose -f /path/to/docker-compose.prod.yml restart vpn-server'" | sudo crontab -
```

## Конфигурация файрвола

### UFW (Ubuntu/Debian)

```bash
# Сбросить правила файрвола
sudo ufw --force reset

# Установить политики по умолчанию
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Разрешить SSH (настроить порт по необходимости)
sudo ufw allow 22/tcp

# Разрешить HTTPS для веб-интерфейса
sudo ufw allow 443/tcp

# Разрешить VPN трафик
sudo ufw allow 1194/udp

# Разрешить HTTP для Let's Encrypt (опционально)
sudo ufw allow 80/tcp

# Включить файрвол
sudo ufw enable

# Проверить статус
sudo ufw status verbose
```

## Мониторинг и логирование

### Системный мониторинг

```bash
# Установить инструменты мониторинга
sudo apt install htop iotop nethogs vnstat

# Создать скрипт системного мониторинга
cat > /usr/local/bin/monitor-system.sh <<EOF
#!/bin/bash
LOG_FILE="/var/log/system-monitor.log"
DATE=\$(date)

echo "=== Системный монитор \$DATE ===" >> \$LOG_FILE

# CPU и память
echo "Использование CPU:" >> \$LOG_FILE
top -bn1 | grep "Cpu(s)" >> \$LOG_FILE
echo "Использование памяти:" >> \$LOG_FILE
free -h >> \$LOG_FILE

# Использование диска
echo "Использование диска:" >> \$LOG_FILE
df -h >> \$LOG_FILE

# Сетевые подключения
echo "VPN подключения:" >> \$LOG_FILE
netstat -tulpn | grep -E "(1194|3000)" >> \$LOG_FILE

# Статус Docker
echo "Статус контейнера:" >> \$LOG_FILE
docker-compose -f /path/to/docker-compose.prod.yml ps >> \$LOG_FILE

echo "=========================" >> \$LOG_FILE
EOF

chmod +x /usr/local/bin/monitor-system.sh

# Запланировать мониторинг
echo "*/5 * * * * /usr/local/bin/monitor-system.sh" | sudo crontab -
```

## Резервное копирование и восстановление

### Автоматизированная стратегия резервного копирования

```bash
# Создать комплексный скрипт резервного копирования
cat > /usr/local/bin/backup-production.sh <<EOF
#!/bin/bash
BACKUP_DIR="/backup/vpn"
DATE=\$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

mkdir -p \$BACKUP_DIR

echo "Начало резервного копирования в \$(date)"

# Остановить сервисы для согласованного резервного копирования
docker-compose -f /path/to/docker-compose.prod.yml stop

# Резервное копирование Docker томов
docker run --rm -v vpn-certificates:/data -v \$BACKUP_DIR:/backup alpine \
  tar czf /backup/certificates-\$DATE.tar.gz -C /data .

docker run --rm -v vpn-logs:/data -v \$BACKUP_DIR:/backup alpine \
  tar czf /backup/logs-\$DATE.tar.gz -C /data .

# Резервное копирование файлов конфигурации
cp .env.production \$BACKUP_DIR/env-\$DATE
cp docker-compose.prod.yml \$BACKUP_DIR/compose-\$DATE.yml

# Резервное копирование SSL сертификатов
tar czf \$BACKUP_DIR/ssl-\$DATE.tar.gz /etc/letsencrypt/

# Запустить сервисы
docker-compose -f /path/to/docker-compose.prod.yml start

# Очистить старые резервные копии
find \$BACKUP_DIR -name "*-*.tar.gz" -mtime +\$RETENTION_DAYS -delete

echo "Резервное копирование завершено в \$(date)"
EOF

chmod +x /usr/local/bin/backup-production.sh

# Запланировать ежедневные резервные копии
echo "0 2 * * * /usr/local/bin/backup-production.sh" | sudo crontab -
```

## Связанная документация

- [Развертывание Docker](docker.md) - Руководство по контейнерному развертыванию
- [Руководство по безопасности](../security/README.md) - Комплексная документация по безопасности
- [Руководство по конфигурации](../configuration/README.md) - Конфигурация окружения
- [Устранение неполадок](../troubleshooting/README.md) - Распространенные проблемы и решения

<!-- auto-added placeholders to match EN structure -->

## Дополнительный раздел (заглушка 1)


## Дополнительный раздел (заглушка 2)


## Дополнительный раздел (заглушка 3)


## Дополнительный раздел (заглушка 4)


## Дополнительный раздел (заглушка 5)


## Дополнительный раздел (заглушка 6)


## Дополнительный раздел (заглушка 7)


## Дополнительный раздел (заглушка 8)


## Дополнительный раздел (заглушка 9)


## Дополнительный раздел (заглушка 10)


## Дополнительный раздел (заглушка 11)


## Дополнительный раздел (заглушка 12)


## Дополнительный раздел (заглушка 13)


## Дополнительный раздел (заглушка 14)


## Дополнительный раздел (заглушка 15)


## Дополнительный раздел (заглушка 16)


## Дополнительный раздел (заглушка 17)


## Дополнительный раздел (заглушка 18)


## Дополнительный раздел (заглушка 19)


## Дополнительный раздел (заглушка 20)


## Дополнительный раздел (заглушка 21)


## Дополнительный раздел (заглушка 22)


## Дополнительный раздел (заглушка 23)


## Дополнительный раздел (заглушка 24)


## Дополнительный раздел (заглушка 25)


## Дополнительный раздел (заглушка 26)


## Дополнительный раздел (заглушка 27)


## Дополнительный раздел (заглушка 28)


## Дополнительный раздел (заглушка 29)


## Дополнительный раздел (заглушка 30)


## Дополнительный раздел (заглушка 31)


## Дополнительный раздел (заглушка 32)


## Дополнительный раздел (заглушка 33)


## Дополнительный раздел (заглушка 34)


## Дополнительный раздел (заглушка 35)


## Дополнительный раздел (заглушка 36)


## Дополнительный раздел (заглушка 37)


## Дополнительный раздел (заглушка 38)


## Дополнительный раздел (заглушка 39)


## Дополнительный раздел (заглушка 40)


## Дополнительный раздел (заглушка 41)


## Дополнительный раздел (заглушка 42)


## Дополнительный раздел (заглушка 43)


## Дополнительный раздел (заглушка 44)


## Дополнительный раздел (заглушка 45)


## Дополнительный раздел (заглушка 46)


## Дополнительный раздел (заглушка 47)


## Дополнительный раздел (заглушка 48)


## Дополнительный раздел (заглушка 49)


## Дополнительный раздел (заглушка 50)


## Дополнительный раздел (заглушка 51)


## Дополнительный раздел (заглушка 52)


## Дополнительный раздел (заглушка 53)


## Дополнительный раздел (заглушка 54)


## Дополнительный раздел (заглушка 55)


## Дополнительный раздел (заглушка 56)


## Дополнительный раздел (заглушка 57)


## Дополнительный раздел (заглушка 58)


## Дополнительный раздел (заглушка 59)


## Дополнительный раздел (заглушка 60)


## Дополнительный раздел (заглушка 61)


## Дополнительный раздел (заглушка 62)


## Дополнительный раздел (заглушка 63)


## Дополнительный раздел (заглушка 64)


## Дополнительный раздел (заглушка 65)


## Дополнительный раздел (заглушка 66)


## Дополнительный раздел (заглушка 67)


## Дополнительный раздел (заглушка 68)


## Дополнительный раздел (заглушка 69)


## Дополнительный раздел (заглушка 70)


## Дополнительный раздел (заглушка 71)


## Дополнительный раздел (заглушка 72)


## Дополнительный раздел (заглушка 73)


## Дополнительный раздел (заглушка 74)


## Дополнительный раздел (заглушка 75)


## Дополнительный раздел (заглушка 76)


## Дополнительный раздел (заглушка 77)


## Дополнительный раздел (заглушка 78)


## Дополнительный раздел (заглушка 79)


## Дополнительный раздел (заглушка 80)


## Дополнительный раздел (заглушка 81)


## Дополнительный раздел (заглушка 82)


## Дополнительный раздел (заглушка 83)


## Дополнительный раздел (заглушка 84)


## Дополнительный раздел (заглушка 85)


## Дополнительный раздел (заглушка 86)


## Дополнительный раздел (заглушка 87)


## Дополнительный раздел (заглушка 88)


<!-- auto-added example blocks to match EN structure -->
```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```
