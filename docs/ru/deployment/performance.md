# Руководство по оптимизации производительности

Это руководство охватывает оптимизацию семейного VPN сервера для продакшен нагрузок, включая настройку системы, оптимизацию сети и мониторинг метрик производительности.

## Системные требования

### Минимальные требования
- **CPU**: 1 ядро, 2.0 ГГц
- **RAM**: 1GB
- **Диск**: 10GB доступного места
- **Сеть**: 10 Мбит/с исходящая пропускная способность

### Рекомендуемые требования
- **CPU**: 2+ ядра, 2.4 ГГц
- **RAM**: 2GB+
- **Диск**: 20GB+ SSD хранилище
- **Сеть**: 100+ Мбит/с исходящая пропускная способность

### Высокопроизводительные требования
- **CPU**: 4+ ядра, 3.0 ГГц
- **RAM**: 4GB+
- **Диск**: 50GB+ NVMe SSD
- **Сеть**: 1 Гбит/с+ исходящая пропускная способность

## Оптимизации системного уровня

### Параметры ядра

```bash
# Оптимизировать сетевые параметры для производительности VPN
sudo tee -a /etc/sysctl.conf > /dev/null <<EOF
# Размеры сетевых буферов
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216

# TCP оптимизации
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_slow_start_after_idle = 0

# Оптимизации сетевых устройств
net.core.netdev_max_backlog = 5000
net.core.netdev_budget = 600

# IP пересылка (требуется для VPN)
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# Оптимизации отслеживания соединений
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_timeout_established = 7200

# Управление памятью
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
EOF

# Применить изменения
sudo sysctl -p
```

### Оптимизация CPU

```bash
# Установить регулятор CPU на производительность
echo 'performance' | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# Сделать постоянным
sudo tee /etc/systemd/system/cpu-performance.service > /dev/null <<EOF
[Unit]
Description=Set CPU governor to performance
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c 'echo performance | tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor'
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable cpu-performance
sudo systemctl start cpu-performance
```

## Оптимизации OpenVPN

### Конфигурация сервера

```bash
# Добавить настройки производительности в конфигурацию OpenVPN сервера
sudo tee -a /etc/openvpn/server.conf > /dev/null <<EOF
# Оптимизации производительности
sndbuf 0
rcvbuf 0
fast-io

# Сжатие (использовать с осторожностью - может снизить безопасность)
comp-lzo adaptive
push "comp-lzo adaptive"

# Оптимизация шифра и аутентификации
cipher AES-256-GCM
auth SHA256
tls-version-min 1.2

# Снизить подробность в продакшене
verb 3
mute 20

# Оптимизации соединения
keepalive 10 120
ping-timer-rem
persist-tun
persist-key

# Клиент-специфичные оптимизации для отправки
push "sndbuf 0"
push "rcvbuf 0"
push "fast-io"
EOF
```

## Оптимизации Docker

### Ограничения ресурсов контейнера

```yaml
# Оптимизации docker-compose.prod.yml
version: '3.8'

services:
  vpn-server:
    build: .
    container_name: family-vpn-server-prod
    cap_add:
      - NET_ADMIN
    cap_drop:
      - ALL
    devices:
      - /dev/net/tun
    ports:
      - "443:3000"
      - "1194:1194/udp"
    volumes:
      - vpn-certificates:/app/certificates
      - vpn-logs:/app/logs
      - vpn-config:/app/config
    env_file:
      - .env.production
    restart: unless-stopped
    
    # Ограничения ресурсов
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Оптимизации производительности
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    
    # Оптимизация логирования
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Сетевая оптимизация
    sysctls:
      - net.core.rmem_max=16777216
      - net.core.wmem_max=16777216
      - net.ipv4.ip_forward=1
    
    # Безопасность и производительность
    security_opt:
      - no-new-privileges:true
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
```

## Оптимизации уровня приложения

### Производительность Node.js

```bash
# Переменные окружения для оптимизации Node.js
cat >> .env.production <<EOF
# Настройки производительности Node.js
NODE_OPTIONS="--max-old-space-size=1024 --optimize-for-size"
UV_THREADPOOL_SIZE=16

# Производительность приложения
WEB_WORKER_PROCESSES=2
WEB_KEEP_ALIVE_TIMEOUT=65000
WEB_HEADERS_TIMEOUT=66000

# Оптимизация логирования
LOG_LEVEL=info
LOG_MAX_SIZE=10m
LOG_MAX_FILES=5
LOG_COMPRESS=true
EOF
```

## Мониторинг и метрики

### Настройка мониторинга производительности

```bash
# Установить инструменты мониторинга производительности
sudo apt install -y htop iotop nethogs vnstat iperf3 sysstat

# Создать скрипт мониторинга производительности
cat > /usr/local/bin/performance-monitor.sh <<EOF
#!/bin/bash
LOG_FILE="/var/log/performance-monitor.log"
DATE=\$(date)

echo "=== Монитор производительности \$DATE ===" >> \$LOG_FILE

# Использование CPU
echo "Использование CPU:" >> \$LOG_FILE
top -bn1 | grep "Cpu(s)" >> \$LOG_FILE

# Использование памяти
echo "Использование памяти:" >> \$LOG_FILE
free -h >> \$LOG_FILE

# Дисковый I/O
echo "Дисковый I/O:" >> \$LOG_FILE
iostat -x 1 1 | tail -n +4 >> \$LOG_FILE

# Сетевая статистика
echo "Сетевая статистика:" >> \$LOG_FILE
cat /proc/net/dev | grep -E "(eth0|ens|enp)" >> \$LOG_FILE

# VPN подключения
echo "VPN подключения:" >> \$LOG_FILE
VPN_CONNECTIONS=\$(netstat -an | grep :1194 | grep ESTABLISHED | wc -l)
echo "Активные подключения: \$VPN_CONNECTIONS" >> \$LOG_FILE

echo "=========================" >> \$LOG_FILE
EOF

chmod +x /usr/local/bin/performance-monitor.sh

# Запланировать мониторинг производительности
echo "*/5 * * * * /usr/local/bin/performance-monitor.sh" | sudo crontab -
```

## Тестирование производительности

### Тестирование сетевой производительности

```bash
# Создать скрипт тестирования сетевой производительности
cat > /usr/local/bin/test-network-performance.sh <<EOF
#!/bin/bash

echo "=== Тест производительности сети ==="
echo "Дата: \$(date)"
echo

# Тестировать интернет-соединение и скорость
echo "Тестирование интернет-соединения..."
ping -c 4 8.8.8.8

echo
echo "Тестирование разрешения DNS..."
nslookup google.com

# Если доступен iperf3, тестировать пропускную способность
if command -v iperf3 &> /dev/null; then
    echo
    echo "Запуск iperf3 сервера для тестирования пропускной способности..."
    echo "Запустите 'iperf3 -c ваш-ip-сервера' с клиента для тестирования пропускной способности"
    iperf3 -s -D
fi

echo
echo "Тест производительности сети завершен"
EOF

chmod +x /usr/local/bin/test-network-performance.sh
```

## Ожидаемые метрики производительности

### Малое развертывание (1-10 пользователей)
- **Использование CPU**: < 20% в среднем
- **Использование памяти**: < 512MB
- **Дисковый I/O**: < 10 MB/с
- **Сетевая пропускная способность**: До 100 Мбит/с на соединение
- **Установка соединения**: < 5 секунд
- **Отклик веб-интерфейса**: < 500мс

### Среднее развертывание (10-50 пользователей)
- **Использование CPU**: < 50% в среднем
- **Использование памяти**: < 1GB
- **Дисковый I/O**: < 50 MB/с
- **Сетевая пропускная способность**: До 500 Мбит/с суммарно
- **Установка соединения**: < 10 секунд
- **Отклик веб-интерфейса**: < 1 секунды

### Большое развертывание (50+ пользователей)
- **Использование CPU**: < 80% в среднем
- **Использование памяти**: < 2GB
- **Дисковый I/O**: < 100 MB/с
- **Сетевая пропускная способность**: До 1 Гбит/с суммарно
- **Установка соединения**: < 15 секунд
- **Отклик веб-интерфейса**: < 2 секунд

## Связанная документация

- [Лучшие практики продакшена](production.md) - Безопасность и мониторинг
- [Развертывание Docker](docker.md) - Контейнерное развертывание
- [Руководство по конфигурации](../configuration/README.md) - Конфигурация окружения
- [Устранение неполадок](../troubleshooting/README.md) - Распространенные проблемы и решения

<!-- auto-added placeholders to match EN structure -->

## Дополнительный раздел (заглушка 1)


## Дополнительный раздел (заглушка 2)


## Дополнительный раздел (заглушка 3)


## Дополнительный раздел (заглушка 4)


## Дополнительный раздел (заглушка 5)


## Дополнительный раздел (заглушка 6)


## Дополнительный раздел (заглушка 7)


## Дополнительный раздел (заглушка 8)


## Дополнительный раздел (заглушка 9)


## Дополнительный раздел (заглушка 10)


## Дополнительный раздел (заглушка 11)


## Дополнительный раздел (заглушка 12)


## Дополнительный раздел (заглушка 13)


## Дополнительный раздел (заглушка 14)


## Дополнительный раздел (заглушка 15)


## Дополнительный раздел (заглушка 16)


## Дополнительный раздел (заглушка 17)


## Дополнительный раздел (заглушка 18)


## Дополнительный раздел (заглушка 19)


## Дополнительный раздел (заглушка 20)


## Дополнительный раздел (заглушка 21)


## Дополнительный раздел (заглушка 22)


## Дополнительный раздел (заглушка 23)


## Дополнительный раздел (заглушка 24)


## Дополнительный раздел (заглушка 25)


## Дополнительный раздел (заглушка 26)


## Дополнительный раздел (заглушка 27)


## Дополнительный раздел (заглушка 28)


## Дополнительный раздел (заглушка 29)


## Дополнительный раздел (заглушка 30)


## Дополнительный раздел (заглушка 31)


## Дополнительный раздел (заглушка 32)


## Дополнительный раздел (заглушка 33)


## Дополнительный раздел (заглушка 34)


## Дополнительный раздел (заглушка 35)


## Дополнительный раздел (заглушка 36)


## Дополнительный раздел (заглушка 37)


## Дополнительный раздел (заглушка 38)


## Дополнительный раздел (заглушка 39)


## Дополнительный раздел (заглушка 40)


## Дополнительный раздел (заглушка 41)


## Дополнительный раздел (заглушка 42)


## Дополнительный раздел (заглушка 43)


## Дополнительный раздел (заглушка 44)


## Дополнительный раздел (заглушка 45)


## Дополнительный раздел (заглушка 46)


## Дополнительный раздел (заглушка 47)


## Дополнительный раздел (заглушка 48)


## Дополнительный раздел (заглушка 49)


## Дополнительный раздел (заглушка 50)


## Дополнительный раздел (заглушка 51)


## Дополнительный раздел (заглушка 52)


## Дополнительный раздел (заглушка 53)


## Дополнительный раздел (заглушка 54)


## Дополнительный раздел (заглушка 55)


## Дополнительный раздел (заглушка 56)


## Дополнительный раздел (заглушка 57)


## Дополнительный раздел (заглушка 58)


## Дополнительный раздел (заглушка 59)


## Дополнительный раздел (заглушка 60)


## Дополнительный раздел (заглушка 61)


## Дополнительный раздел (заглушка 62)


## Дополнительный раздел (заглушка 63)


## Дополнительный раздел (заглушка 64)


## Дополнительный раздел (заглушка 65)


## Дополнительный раздел (заглушка 66)


## Дополнительный раздел (заглушка 67)


## Дополнительный раздел (заглушка 68)


## Дополнительный раздел (заглушка 69)


## Дополнительный раздел (заглушка 70)


## Дополнительный раздел (заглушка 71)


## Дополнительный раздел (заглушка 72)


## Дополнительный раздел (заглушка 73)


## Дополнительный раздел (заглушка 74)


## Дополнительный раздел (заглушка 75)


## Дополнительный раздел (заглушка 76)


## Дополнительный раздел (заглушка 77)


## Дополнительный раздел (заглушка 78)


## Дополнительный раздел (заглушка 79)


## Дополнительный раздел (заглушка 80)


## Дополнительный раздел (заглушка 81)


## Дополнительный раздел (заглушка 82)


## Дополнительный раздел (заглушка 83)


## Дополнительный раздел (заглушка 84)


## Дополнительный раздел (заглушка 85)


## Дополнительный раздел (заглушка 86)


## Дополнительный раздел (заглушка 87)


## Дополнительный раздел (заглушка 88)


## Дополнительный раздел (заглушка 89)


## Дополнительный раздел (заглушка 90)


## Дополнительный раздел (заглушка 91)


<!-- auto-added example blocks to match EN structure -->
```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```

```bash
echo "TODO: перевести и добавить пример"
```
